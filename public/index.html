<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrance Tools</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@nicktomlin/novnc@0.0.5/core/css/base.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            /* 暗色主题 */
            --color-bg-deep: #111;
            --color-bg-1: #1a1a1a;
            --color-bg-2: #202020;
            --color-bg-3: #2a2a2a;
            --color-bg-acrylic: rgba(32, 32, 32, 0.85);
            --color-accent: #0078D7;
            --color-accent-hover: #1a86dc;
            --color-accent-light: rgba(0, 120, 215, 0.3);
            --color-text: #fff;
            --color-text-2: #a0a0a0;
            --color-text-3: #6a6a6a;
            --color-border: #3a3a3a;
            --color-success: #107c10;
            --color-warning: #ff8c00;
            --color-error: #e81123;
            --sidebar-width: 240px;
            --sidebar-collapsed: 60px;
            --terminal-bg: #1a1a1a;
        }

        /* 亮色主题 */
        [data-theme="light"] {
            --color-bg-deep: #f0f2f5;
            --color-bg-1: #ffffff;
            --color-bg-2: #f5f5f5;
            --color-bg-3: #e8e8e8;
            --color-bg-acrylic: rgba(255, 255, 255, 0.85);
            --color-text: #1a1a1a;
            --color-text-2: #666666;
            --color-text-3: #999999;
            --color-border: #d0d0d0;
            --terminal-bg: #1a1a1a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--color-bg-deep);
            color: var(--color-text);
            height: 100vh;
            overflow: hidden;
            transition: background .3s, color .3s;
        }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--color-text-2); font-size: 13px; }
        .form-input {
            width: 100%; padding: 12px 14px;
            background: var(--color-bg-2); border: 1px solid var(--color-border);
            border-radius: 6px; color: var(--color-text); font-size: 14px;
            transition: border-color .2s, box-shadow .2s, background .3s;
        }
        .form-input:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px var(--color-accent-light); }
        .form-input::placeholder { color: var(--color-text-3); }

        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 12px 20px; background: var(--color-accent); color: #fff;
            border: none; border-radius: 6px; font-size: 14px; font-weight: 500;
            cursor: pointer; transition: background .2s, transform .1s;
        }
        .btn:hover { background: var(--color-accent-hover); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-block { width: 100%; }
        .btn-secondary { background: var(--color-bg-3); border: 1px solid var(--color-border); color: var(--color-text); }
        .btn-secondary:hover { background: var(--color-border); }
        .btn-success { background: var(--color-success); }
        .btn-danger { background: var(--color-error); }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        .btn-icon { padding: 8px; min-width: 36px; }

        /* 仪表板 */
        .dashboard { display: flex; height: 100vh; opacity: 0; visibility: hidden; transition: opacity .4s, visibility .4s; }
        .dashboard.visible { opacity: 1; visibility: visible; }

        /* 侧边栏 */
        .sidebar {
            width: var(--sidebar-width); height: 100vh;
            background: var(--color-bg-acrylic); backdrop-filter: blur(20px);
            border-right: 1px solid var(--color-border);
            display: flex; flex-direction: column;
            transition: width .3s cubic-bezier(.4,0,.2,1), background .3s, border-color .3s;
            flex-shrink: 0; overflow: hidden;
        }
        .sidebar.collapsed { width: var(--sidebar-collapsed); }
        .sidebar-header {
            padding: 20px; border-bottom: 1px solid var(--color-border);
            display: flex; align-items: center; gap: 12px;
            transition: border-color .3s;
        }
        .sidebar-logo {
            width: 28px; height: 28px; background: var(--color-accent);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; color: #fff;
        }
        .sidebar-title { font-size: 16px; font-weight: 600; white-space: nowrap; transition: opacity .2s; }
        .sidebar.collapsed .sidebar-title { opacity: 0; }
        .sidebar-nav { flex: 1; padding: 12px; overflow-y: auto; }
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px; margin-bottom: 4px; border-radius: 8px;
            cursor: pointer; transition: background .15s;
            position: relative; --x: 50%; --y: 50%;
        }
        .nav-item::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle 120px at var(--x) var(--y), rgba(0,120,215,0.1), transparent);
            opacity: 0; transition: opacity .15s; pointer-events: none;
        }
        .nav-item:hover::before { opacity: 1; }
        .nav-item:hover { background: var(--color-bg-3); }
        .nav-item.active { background: var(--color-accent-light); }
        .nav-item i { width: 20px; text-align: center; flex-shrink: 0; }
        .nav-item span { white-space: nowrap; transition: opacity .2s; }
        .sidebar.collapsed .nav-item span { opacity: 0; }
        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--color-border);
            transition: border-color .3s;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toggle-btn {
            width: 100%; padding: 12px; background: var(--color-bg-2);
            border: 1px solid var(--color-border); border-radius: 8px;
            color: var(--color-text-2); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: background .15s, color .15s, border-color .3s;
        }
        .toggle-btn:hover { background: var(--color-bg-3); color: var(--color-text); }
        .toggle-btn span { transition: opacity .2s; }
        .sidebar.collapsed .toggle-btn span { opacity: 0; width: 0; }
        .toggle-btn i { transition: transform .3s; }
        .sidebar.collapsed .toggle-btn i { transform: rotate(180deg); }

        /* 主题切换 */
        .theme-toggle {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            width: 44px; height: 44px; border-radius: 50%;
            background: var(--color-bg-2); border: 1px solid var(--color-border);
            color: var(--color-text); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background .3s, border-color .3s, transform .2s;
            font-size: 18px;
        }
        .theme-toggle:hover { transform: scale(1.1); background: var(--color-bg-3); }

        /* 登录遮罩 */
        .auth-overlay {
            position: fixed; inset: 0; z-index: 200;
            background: radial-gradient(circle at 20% 20%, rgba(0,120,215,0.2), transparent 60%),
                        radial-gradient(circle at 80% 80%, rgba(16,124,16,0.15), transparent 55%),
                        rgba(0,0,0,0.65);
            display: flex; align-items: center; justify-content: center;
            transition: opacity .3s, visibility .3s;
        }
        .auth-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .auth-card {
            width: 340px; padding: 24px;
            background: var(--color-bg-1);
            border: 1px solid var(--color-border);
            border-radius: 14px;
            box-shadow: 0 24px 60px rgba(0,0,0,0.4);
        }
        .auth-title { font-size: 20px; font-weight: 600; margin-bottom: 6px; }
        .auth-sub { color: var(--color-text-2); font-size: 13px; margin-bottom: 18px; }
        .auth-error { min-height: 16px; color: var(--color-error); font-size: 12px; margin-top: 8px; }
        .logout-btn {
            background: var(--color-bg-3);
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }
        .logout-btn:hover { background: var(--color-border); }

        /* 主内容 */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header {
            padding: 20px; border-bottom: 1px solid var(--color-border);
            background: var(--color-bg-1);
            transition: background .3s, border-color .3s;
        }
        .header h2 { font-size: 18px; display: flex; align-items: center; gap: 12px; }
        .header h2 i { color: var(--color-accent); }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .view { display: none; height: 100%; flex-direction: column; }
        .view.active { display: flex; }

        /* SSH */
        .toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: flex-end; }
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        .input-group label { font-size: 12px; color: var(--color-text-2); }
        .input-group .form-input { min-width: 120px; padding: 10px 12px; }
        .auth-key-panel {
            width: 100%;
            display: none;
            gap: 12px;
            padding: 12px;
            background: var(--color-bg-1);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .auth-key-panel.active { display: flex; }
        .auth-key-panel .input-group { flex: 1; min-width: 220px; }
        .auth-key-panel .input-group.key-input-group { min-width: 360px; flex: 2; }
        .key-input {
            min-height: 96px;
            resize: vertical;
            white-space: pre;
            font-family: Consolas, Monaco, monospace;
            line-height: 1.35;
        }
        .hosts-section { margin-bottom: 20px; }
        .hosts-section h3 { font-size: 13px; color: var(--color-text-2); margin-bottom: 12px; }
        .hosts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .host-card {
            background: var(--color-bg-2); border: 1px solid var(--color-border);
            border-radius: 8px; padding: 14px; cursor: pointer;
            transition: background .15s, border-color .15s;
            position: relative; --x: 50%; --y: 50%;
        }
        .host-card::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle 150px at var(--x) var(--y), var(--color-accent-light), transparent);
            opacity: 0; transition: opacity .15s; pointer-events: none; border-radius: 8px;
        }
        .host-card:hover::before { opacity: 0.5; }
        .host-card:hover { background: var(--color-bg-3); }
        .host-card.connected { border-color: var(--color-success); }
        .host-card-content { position: relative; z-index: 1; }
        .host-info { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .host-info i { font-size: 18px; color: var(--color-accent); }
        .host-ip { font-family: Consolas, monospace; font-size: 14px; font-weight: 500; }
        .host-details { font-size: 12px; color: var(--color-text-3); margin-bottom: 10px; }
        .host-auth-tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--color-accent-light);
            color: var(--color-accent);
            font-size: 11px;
            margin-bottom: 10px;
        }
        .host-actions { display: flex; gap: 8px; }
        .host-actions .btn { flex: 1; padding: 6px 10px; font-size: 12px; }
        .host-delete {
            position: absolute; top: 8px; right: 8px;
            background: none; border: none; color: var(--color-text-3);
            cursor: pointer; padding: 4px; border-radius: 4px;
            transition: color .15s, background .15s;
        }
        .host-delete:hover { color: var(--color-error); background: rgba(232,17,35,0.1); }
        .terminal-box {
            flex: 1; background: var(--terminal-bg); border: 1px solid var(--color-border);
            border-radius: 8px; padding: 12px; min-height: 300px;
            display: flex; flex-direction: column;
        }
        .terminal-header {
            display: flex; align-items: center; gap: 8px;
            padding-bottom: 12px; border-bottom: 1px solid var(--color-border); margin-bottom: 12px;
        }
        .terminal-dot { width: 12px; height: 12px; border-radius: 50%; }
        .terminal-dot.red { background: var(--color-error); }
        .terminal-dot.yellow { background: var(--color-warning); }
        .terminal-dot.green { background: var(--color-success); }
        .terminal-title { flex: 1; margin-left: 12px; color: #a0a0a0; font-size: 13px; }
        .terminal-status { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .terminal-status.connected { color: var(--color-success); }
        .terminal-status.disconnected { color: #6a6a6a; }
        #terminal { flex: 1; }

        /* System Stats Monitor */
        .sys-stats-container {
            margin-top: 12px;
            background: var(--color-bg-2);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            overflow: hidden;
            transition: all .3s ease;
        }
        .sys-stats-hint {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background .2s;
        }
        .sys-stats-hint:hover {
            background: var(--color-bg-3);
        }
        .sys-stats-hint .hint-stats {
            display: flex;
            gap: 16px;
        }
        .sys-stats-hint .hint-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .sys-stats-hint .hint-cpu { color: #0078D7; }
        .sys-stats-hint .hint-mem { color: #107c10; }
        .sys-stats-hint .hint-disk { color: #ff8c00; }
        .sys-stats-hint .hint-expand {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--color-text-3);
            font-size: 11px;
        }
        .sys-stats-hint:hover .hint-expand {
            color: var(--color-accent);
        }
        .sys-stats-panel {
            display: none;
            border-top: 1px solid var(--color-border);
        }
        .sys-stats-container.active .sys-stats-panel {
            display: block;
        }
        .sys-stats-header {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 8px 12px;
            background: var(--color-bg-2);
            border-bottom: 1px solid var(--color-border);
        }
        .sys-stats-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .sys-stats-chart-wrapper {
            position: relative;
            width: 100%;
            height: 180px;
            padding: 8px 12px;
            background: var(--color-bg-1);
        }
        .sys-stats-chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* TOP Panel */
        .top-panel-container {
            margin-top: 12px;
            background: var(--color-bg-2);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            overflow: hidden;
            transition: all .3s ease;
        }
        .top-panel-hint {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background .2s;
        }
        .top-panel-hint:hover {
            background: var(--color-bg-3);
        }
        .top-panel-hint .hint-info {
            display: flex;
            gap: 16px;
        }
        .top-panel-hint .hint-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .top-panel-hint .hint-procs { color: #0078D7; }
        .top-panel-hint .hint-running { color: #107c10; }
        .top-panel-hint .hint-load { color: #ff8c00; }
        .top-panel-hint .hint-expand {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--color-text-3);
            font-size: 11px;
        }
        .top-panel-hint:hover .hint-expand {
            color: var(--color-accent);
        }
        .top-panel-content {
            display: none;
            border-top: 1px solid var(--color-border);
        }
        .top-panel-container.active .top-panel-content {
            display: block;
        }
        .top-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--color-bg-2);
            border-bottom: 1px solid var(--color-border);
        }
        .top-panel-header h4 {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .top-panel-header h4 i {
            color: var(--color-accent);
        }
        .top-panel-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .top-panel-controls label {
            font-size: 11px;
            color: var(--color-text-2);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .top-panel-controls select {
            padding: 4px 8px;
            font-size: 11px;
            background: var(--color-bg-3);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text);
        }
        .top-panel-summary {
            display: flex;
            gap: 24px;
            padding: 10px 12px;
            background: var(--color-bg-1);
            border-bottom: 1px solid var(--color-border);
            font-size: 12px;
        }
        .top-summary-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .top-summary-label {
            color: var(--color-text-3);
            font-size: 10px;
            text-transform: uppercase;
        }
        .top-summary-value {
            color: var(--color-text);
            font-family: Consolas, monospace;
        }
        .top-panel-table-wrapper {
            max-height: 300px;
            overflow-y: auto;
            background: var(--color-bg-1);
        }
        .top-panel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            font-family: Consolas, monospace;
        }
        .top-panel-table th {
            position: sticky;
            top: 0;
            background: var(--color-bg-2);
            padding: 6px 8px;
            text-align: left;
            font-weight: 500;
            color: var(--color-text-2);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            user-select: none;
        }
        .top-panel-table th:hover {
            background: var(--color-bg-3);
        }
        .top-panel-table th.sorted-asc::after {
            content: ' ▲';
            font-size: 9px;
        }
        .top-panel-table th.sorted-desc::after {
            content: ' ▼';
            font-size: 9px;
        }
        .top-panel-table td {
            padding: 5px 8px;
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .top-panel-table tr:hover {
            background: var(--color-bg-2);
        }
        .top-panel-table .col-pid { width: 60px; text-align: right; }
        .top-panel-table .col-user { width: 80px; }
        .top-panel-table .col-cpu { width: 60px; text-align: right; color: #0078D7; }
        .top-panel-table .col-mem { width: 60px; text-align: right; color: #107c10; }
        .top-panel-table .col-vsz { width: 80px; text-align: right; }
        .top-panel-table .col-rss { width: 80px; text-align: right; }
        .top-panel-table .col-stat { width: 50px; text-align: center; }
        .top-panel-table .col-time { width: 80px; text-align: right; }
        .top-panel-table .col-cmd { min-width: 200px; }
        .top-cpu-bar, .top-mem-bar {
            display: inline-block;
            height: 10px;
            border-radius: 2px;
            margin-right: 4px;
            vertical-align: middle;
        }
        .top-cpu-bar { background: rgba(0, 120, 215, 0.6); }
        .top-mem-bar { background: rgba(16, 124, 16, 0.6); }
        .top-panel-table .col-action { width: 50px; text-align: center; }
        .top-kill-btn {
            padding: 2px 6px;
            font-size: 10px;
            background: var(--color-bg-3);
            border: 1px solid var(--color-border);
            border-radius: 3px;
            color: var(--color-text-2);
            cursor: pointer;
            transition: all .2s;
        }
        .top-kill-btn:hover {
            background: #e81123;
            border-color: #e81123;
            color: #fff;
        }

        /* Kill Modal */
        .kill-process-info {
            background: var(--color-bg-1);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 12px;
            font-size: 13px;
        }
        .kill-info-row {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
        }
        .kill-info-row:last-child { margin-bottom: 0; }
        .kill-info-row span { color: var(--color-text-3); min-width: 50px; }
        .kill-info-row code {
            background: var(--color-bg-2);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .signal-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 240px;
            overflow-y: auto;
        }
        .signal-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: var(--color-bg-1);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            cursor: pointer;
            transition: all .2s;
        }
        .signal-option:hover {
            background: var(--color-bg-2);
            border-color: var(--color-accent);
        }
        .signal-option input[type="radio"] {
            margin-top: 3px;
            accent-color: var(--color-accent);
        }
        .signal-option input[type="radio"]:checked + .signal-label strong {
            color: var(--color-accent);
        }
        .signal-label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .signal-label strong {
            font-size: 13px;
            font-family: Consolas, monospace;
        }
        .signal-label small {
            font-size: 11px;
            color: var(--color-text-3);
        }

        /* SFTP */
        .sftp-status {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px; background: var(--color-bg-2);
            border-radius: 8px; margin-bottom: 20px;
            transition: background .3s, border-color .3s;
        }
        .sftp-status.connected { border: 1px solid var(--color-success); }
        .sftp-status.disconnected { border: 1px solid var(--color-border); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--color-text-3); }
        .sftp-status.connected .status-dot { background: var(--color-success); }
        .sftp-status-text { flex: 1; font-size: 14px; }
        .file-pane {
            flex: 1; background: var(--color-bg-1); border: 1px solid var(--color-border);
            border-radius: 8px; display: flex; flex-direction: column; overflow: hidden;
            min-height: 300px; transition: background .3s, border-color .3s;
        }
        .file-pane-header {
            padding: 12px 16px; background: var(--color-bg-2);
            border-bottom: 1px solid var(--color-border);
            display: flex; align-items: center; justify-content: space-between;
            transition: background .3s, border-color .3s;
        }
        .file-pane-header h3 { font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .file-pane-header h3 i { color: var(--color-accent); }
        .file-pane-actions { display: flex; gap: 8px; }
        .file-path {
            padding: 8px 16px; background: var(--color-bg-deep);
            border-bottom: 1px solid var(--color-border);
            display: flex; align-items: center; gap: 8px;
            transition: background .3s, border-color .3s;
        }
        .file-path-input {
            flex: 1; background: transparent; border: none;
            color: var(--color-text); font-family: Consolas, monospace; font-size: 12px;
        }
        .file-path-input:focus { outline: none; }
        .file-path-btn {
            background: none; border: none; color: var(--color-text-2);
            cursor: pointer; padding: 4px;
        }
        .file-path-btn:hover { color: var(--color-accent); }
        .file-list-header {
            display: grid; grid-template-columns: 36px 1fr 90px 140px;
            gap: 12px; padding: 8px 16px; font-size: 12px;
            color: var(--color-text-3); border-bottom: 1px solid var(--color-border);
            transition: border-color .3s;
        }
        .file-list { flex: 1; overflow-y: auto; padding: 8px; }
        .file-item {
            display: grid; grid-template-columns: 36px 1fr 90px 140px;
            gap: 12px; align-items: center; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; transition: background .15s;
        }
        .file-item:hover { background: var(--color-bg-2); }
        .file-item.selected { background: var(--color-accent-light); }
        .file-item i { font-size: 16px; text-align: center; }
        .file-item i.fa-folder { color: var(--color-warning); }
        .file-item i.fa-file { color: var(--color-text-2); }
        .file-item i.fa-file-code { color: var(--color-accent); }
        .file-item i.fa-file-image { color: #e91e63; }
        .file-item i.fa-file-archive { color: #9c27b0; }
        .file-name { font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-size { font-size: 12px; color: var(--color-text-3); text-align: right; }
        .file-modified { font-size: 12px; color: var(--color-text-3); }
        .upload-area {
            margin-top: 20px; padding: 24px; background: var(--color-bg-1);
            border: 2px dashed var(--color-border); border-radius: 8px; text-align: center;
            transition: background .3s, border-color .3s;
        }
        .upload-area.drag-over { border-color: var(--color-accent); background: var(--color-accent-light); }
        .upload-area i { font-size: 40px; color: var(--color-text-3); margin-bottom: 12px; }
        .upload-area p { color: var(--color-text-2); margin-bottom: 16px; font-size: 14px; }
        .upload-btns { display: flex; gap: 12px; justify-content: center; }
        .upload-progress { margin-top: 16px; display: none; }
        .upload-progress.active { display: block; }
        .progress-bar { height: 6px; background: var(--color-bg-2); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--color-accent); transition: width .3s; }
        .progress-text { font-size: 12px; color: var(--color-text-2); text-align: center; margin-top: 8px; }
        .hidden-input { display: none; }

        /* Admin */
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .admin-card {
            background: var(--color-bg-1); border: 1px solid var(--color-border);
            border-radius: 8px; padding: 20px;
            transition: background .3s, border-color .3s;
        }
        .admin-card h3 { font-size: 15px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .admin-card h3 i { color: var(--color-accent); }
        .user-list { max-height: 400px; overflow-y: auto; }
        .user-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; background: var(--color-bg-2); border-radius: 6px; margin-bottom: 8px;
            transition: background .3s;
        }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar {
            width: 36px; height: 36px; background: var(--color-accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 14px;
        }
        .user-name { font-size: 14px; font-weight: 500; }
        .user-role { font-size: 12px; color: var(--color-text-3); }
        .user-actions { display: flex; gap: 6px; }
        .badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .badge-admin { background: var(--color-accent-light); color: var(--color-accent); }
        .badge-user { background: var(--color-bg-3); color: var(--color-text-2); }
        .add-user-form { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--color-border); }
        .add-user-form h4 { font-size: 13px; color: var(--color-text-2); margin-bottom: 12px; }
        .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
        .form-row .form-input { padding: 10px 12px; }
        select.form-input { cursor: pointer; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
        .stat-value { font-size: 28px; font-weight: 600; color: var(--color-accent); }
        .stat-label { color: var(--color-text-2); font-size: 13px; }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden; transition: opacity .25s, visibility .25s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--color-bg-1); border: 1px solid var(--color-border);
            border-radius: 12px; padding: 24px; width: 400px; max-width: 90%;
            transform: scale(0.95); transition: transform .25s, background .3s, border-color .3s;
        }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal h3 { font-size: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .modal h3 i { color: var(--color-accent); }
        .modal-actions { display: flex; gap: 12px; margin-top: 20px; }
        .modal-actions .btn { flex: 1; }

        /* Toast */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .toast {
            padding: 12px 20px; background: var(--color-bg-2); border: 1px solid var(--color-border);
            border-radius: 8px; display: flex; align-items: center; gap: 12px;
            animation: slideIn .3s ease; transition: background .3s, border-color .3s;
        }
        .toast.success { border-left: 3px solid var(--color-success); }
        .toast.error { border-left: 3px solid var(--color-error); }
        .toast.info { border-left: 3px solid var(--color-accent); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Empty */
        .empty { text-align: center; padding: 40px; color: var(--color-text-2); }
        .empty i { font-size: 40px; color: var(--color-text-3); margin-bottom: 12px; }
        .empty p { font-size: 14px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-bg-1); }
        ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-text-3); }
        .xterm { padding: 8px; }

        /* VNC */
        .vnc-container {
            flex: 1;
            background: #000;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            min-height: 400px;
        }
        .vnc-screen {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .vnc-screen canvas {
            max-width: 100%;
            max-height: 100%;
        }
        .vnc-toolbar {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .vnc-container:hover .vnc-toolbar {
            opacity: 1;
        }
        .vnc-toolbar .btn {
            padding: 8px 12px;
            font-size: 12px;
        }
        .vnc-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--color-text-3);
        }
        .vnc-placeholder i {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .vnc-placeholder p {
            font-size: 14px;
        }

        /* Stat Chart Visualization */
        .statchart-container {
            position: relative;
            width: 100%;
            height: 280px;
            background: var(--color-bg-acrylic);
            backdrop-filter: blur(20px);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            display: none;
            transition: all .3s ease;
        }
        .statchart-container.active {
            display: block;
        }
        .statchart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--color-bg-2);
            border-bottom: 1px solid var(--color-border);
        }
        .statchart-header h4 {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .statchart-header h4 i {
            color: var(--color-accent);
        }
        .statchart-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .statchart-chart-wrapper {
            position: relative;
            width: 100%;
            height: calc(100% - 40px);
            padding: 8px;
        }
        .statchart-chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Waveform Visualization */
        .waveform-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: var(--color-bg-acrylic);
            backdrop-filter: blur(20px);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            display: none;
            transition: all .3s ease;
        }
        .waveform-container.active {
            display: block;
        }
        .waveform-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--color-bg-2);
            border-bottom: 1px solid var(--color-border);
        }
        .waveform-header h4 {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .waveform-header h4 i {
            color: var(--color-accent);
        }
        .waveform-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .waveform-controls label {
            font-size: 11px;
            color: var(--color-text-2);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .waveform-controls input[type="number"] {
            width: 60px;
            padding: 4px 6px;
            font-size: 11px;
            background: var(--color-bg-3);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text);
        }
        .waveform-chart-wrapper {
            position: relative;
            width: 100%;
            height: calc(100% - 40px);
            padding: 8px;
        }
        .waveform-chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .waveform-legend {
            position: absolute;
            top: 8px;
            right: 12px;
            background: var(--color-bg-acrylic);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            z-index: 10;
            max-height: 120px;
            overflow-y: auto;
        }
        .waveform-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }
        .waveform-legend-item:last-child {
            margin-bottom: 0;
        }
        .waveform-legend-color {
            width: 12px;
            height: 3px;
            border-radius: 1px;
        }
        .waveform-legend-label {
            color: var(--color-text-2);
        }
        .waveform-legend-value {
            color: var(--color-text);
            font-family: Consolas, monospace;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <!-- 主题切换 -->
    <button class="theme-toggle" id="themeToggle" title="切换主题">
        <i class="fas fa-moon"></i>
    </button>

    <!-- 登录遮罩 -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <div class="auth-title">Entrance Tools</div>
            <div class="auth-sub">请使用账户登录</div>
            <div class="form-group">
                <label>用户名</label>
                <input type="text" class="form-input" id="loginUser" placeholder="admin">
            </div>
            <div class="form-group">
                <label>密码</label>
                <input type="password" class="form-input" id="loginPass" placeholder="密码">
            </div>
            <button class="btn btn-block" id="loginBtn"><i class="fas fa-right-to-bracket"></i> 登录</button>
            <div class="auth-error" id="authError"></div>
        </div>
    </div>

    <!-- 仪表板 -->
    <div class="dashboard" id="dashboard">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><i class="fas fa-cloud"></i></div>
                <span class="sidebar-title">Entrance Tools</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" data-view="ssh"><i class="fas fa-terminal"></i><span>SSH 终端</span></div>
                <div class="nav-item" data-view="shell"><i class="fas fa-laptop-code"></i><span>本地 Shell</span><span id="shellLinuxBadge" style="font-size:10px;background:var(--color-accent);color:#fff;padding:2px 6px;border-radius:4px;margin-left:auto;display:none">Linux</span></div>
                <div class="nav-item" data-view="sftp"><i class="fas fa-folder-tree"></i><span>SFTP 管理</span></div>
                <div class="nav-item" data-view="vnc"><i class="fas fa-desktop"></i><span>VNC 远程</span></div>
                <div class="nav-item" data-view="security"><i class="fas fa-shield-halved"></i><span>内网白名单</span></div>
                <div class="nav-item" data-view="serial"><i class="fas fa-microchip"></i><span>串口终端</span></div>
            </nav>
            <div class="sidebar-footer">
                <button class="toggle-btn" id="toggleSidebar"><i class="fas fa-chevron-left"></i><span>收起</span></button>
                <button class="toggle-btn logout-btn" id="logoutBtn"><i class="fas fa-right-from-bracket"></i><span>退出</span></button>
            </div>
        </aside>

        <main class="main">
            <!-- SSH -->
            <div class="view active" id="view-ssh">
                <div class="header"><h2><i class="fas fa-terminal"></i> SSH 终端</h2></div>
                <div class="content">
                    <div class="toolbar">
                        <div class="input-group">
                            <label>主机地址</label>
                            <input type="text" class="form-input" id="sshHost" placeholder="192.168.1.100">
                        </div>
                        <div class="input-group">
                            <label>端口</label>
                            <input type="number" class="form-input" id="sshPort" value="22" style="width:70px">
                        </div>
                        <div class="input-group">
                            <label>用户名</label>
                            <input type="text" class="form-input" id="sshUser" placeholder="root">
                        </div>
                        <div class="input-group">
                            <label>认证方式</label>
                            <select class="form-input" id="sshAuthType">
                                <option value="password" selected>密码</option>
                                <option value="key">私钥</option>
                            </select>
                        </div>
                        <div class="input-group" id="sshPasswordGroup">
                            <label>密码</label>
                            <input type="password" class="form-input" id="sshPass" placeholder="密码" maxlength="2048">
                        </div>
                        <div class="auth-key-panel" id="sshKeyPanel">
                            <div class="input-group key-input-group">
                                <label>私钥</label>
                                <textarea class="form-input key-input" id="sshPrivateKey" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----" maxlength="65536" spellcheck="false"></textarea>
                            </div>
                            <div class="input-group">
                                <label>私钥口令（可选）</label>
                                <input type="password" class="form-input" id="sshPassphrase" placeholder="私钥口令" maxlength="4096">
                            </div>
                        </div>
                        <div class="input-group" style="justify-content:flex-end">
                            <label>&nbsp;</label>
                            <button class="btn" id="saveHostBtn"><i class="fas fa-plus"></i> 保存主机</button>
                        </div>
                    </div>
                    <div class="hosts-section">
                        <h3>已保存的主机</h3>
                        <div class="hosts-grid" id="hostsGrid"></div>
                    </div>
                    <div class="terminal-box">
                        <div class="terminal-header">
                            <div class="terminal-dot red"></div>
                            <div class="terminal-dot yellow"></div>
                            <div class="terminal-dot green"></div>
                            <span class="terminal-title" id="termTitle">终端 - 未连接</span>
                            <div class="terminal-status disconnected" id="termStatus"><i class="fas fa-circle"></i><span>未连接</span></div>
                        </div>
                        <div id="terminal"></div>
                    </div>
                    <!-- System Stats Monitor -->
                    <div class="sys-stats-container" id="sysStatsContainer">
                        <div class="sys-stats-hint" id="sysStatsHint">
                            <div class="hint-stats">
                                <div class="hint-stat hint-cpu">
                                    <i class="fas fa-microchip"></i>
                                    <span>CPU:</span>
                                    <span id="statCpuValue">--%</span>
                                </div>
                                <div class="hint-stat hint-mem">
                                    <i class="fas fa-memory"></i>
                                    <span>内存:</span>
                                    <span id="statMemValue">--%</span>
                                </div>
                                <div class="hint-stat hint-disk">
                                    <i class="fas fa-hdd"></i>
                                    <span>I/O:</span>
                                    <span id="statDiskValue">-- KB/s</span>
                                </div>
                            </div>
                            <div class="hint-expand">
                                <span>展开图表</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="sys-stats-panel">
                            <div class="sys-stats-header">
                                <div class="sys-stats-controls">
                                    <button class="btn btn-sm btn-secondary" id="sysStatsClearBtn" title="清除数据"><i class="fas fa-trash"></i></button>
                                    <button class="btn btn-sm btn-secondary" id="sysStatsCloseBtn" title="收起"><i class="fas fa-chevron-up"></i></button>
                                </div>
                            </div>
                            <div class="sys-stats-chart-wrapper">
                                <canvas id="sysStatsCanvas"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- TOP Panel -->
                    <div class="top-panel-container" id="topPanelContainer">
                        <div class="top-panel-hint" id="topPanelHint">
                            <div class="hint-info">
                                <div class="hint-item hint-procs">
                                    <i class="fas fa-tasks"></i>
                                    <span>进程:</span>
                                    <span id="topProcsValue">--</span>
                                </div>
                                <div class="hint-item hint-running">
                                    <i class="fas fa-play-circle"></i>
                                    <span>运行:</span>
                                    <span id="topRunningValue">--</span>
                                </div>
                                <div class="hint-item hint-load">
                                    <i class="fas fa-tachometer-alt"></i>
                                    <span>负载:</span>
                                    <span id="topLoadValue">--</span>
                                </div>
                            </div>
                            <div class="hint-expand">
                                <span>展开进程</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="top-panel-content">
                            <div class="top-panel-header">
                                <h4><i class="fas fa-list-alt"></i> 进程列表 (TOP)</h4>
                                <div class="top-panel-controls">
                                    <label>排序:
                                        <select id="topSortBy">
                                            <option value="cpu">CPU%</option>
                                            <option value="mem">内存%</option>
                                            <option value="pid">PID</option>
                                            <option value="time">时间</option>
                                        </select>
                                    </label>
                                    <label>显示:
                                        <select id="topShowCount">
                                            <option value="15">15</option>
                                            <option value="30" selected>30</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </label>
                                    <button class="btn btn-sm btn-secondary" id="topRefreshBtn" title="刷新"><i class="fas fa-sync-alt"></i></button>
                                    <button class="btn btn-sm btn-secondary" id="topCloseBtn" title="收起"><i class="fas fa-chevron-up"></i></button>
                                </div>
                            </div>
                            <div class="top-panel-summary" id="topSummary">
                                <div class="top-summary-item">
                                    <span class="top-summary-label">运行时间</span>
                                    <span class="top-summary-value" id="topUptime">--</span>
                                </div>
                                <div class="top-summary-item">
                                    <span class="top-summary-label">用户数</span>
                                    <span class="top-summary-value" id="topUsers">--</span>
                                </div>
                                <div class="top-summary-item">
                                    <span class="top-summary-label">负载均值</span>
                                    <span class="top-summary-value" id="topLoadAvg">--</span>
                                </div>
                                <div class="top-summary-item">
                                    <span class="top-summary-label">任务</span>
                                    <span class="top-summary-value" id="topTasks">--</span>
                                </div>
                                <div class="top-summary-item">
                                    <span class="top-summary-label">CPU使用</span>
                                    <span class="top-summary-value" id="topCpuUsage">--</span>
                                </div>
                                <div class="top-summary-item">
                                    <span class="top-summary-label">内存</span>
                                    <span class="top-summary-value" id="topMemUsage">--</span>
                                </div>
                            </div>
                            <div class="top-panel-table-wrapper">
                                <table class="top-panel-table" id="topTable">
                                    <thead>
                                        <tr>
                                            <th class="col-pid" data-sort="pid">PID</th>
                                            <th class="col-user" data-sort="user">USER</th>
                                            <th class="col-cpu" data-sort="cpu">%CPU</th>
                                            <th class="col-mem" data-sort="mem">%MEM</th>
                                            <th class="col-vsz" data-sort="vsz">VSZ</th>
                                            <th class="col-rss" data-sort="rss">RSS</th>
                                            <th class="col-stat" data-sort="stat">STAT</th>
                                            <th class="col-time" data-sort="time">TIME</th>
                                            <th class="col-cmd" data-sort="cmd">COMMAND</th>
                                            <th class="col-action">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topTableBody">
                                        <tr><td colspan="10" style="text-align:center;color:var(--color-text-3);padding:20px">连接SSH后自动获取进程信息</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Local Shell -->
            <div class="view" id="view-shell">
                <div class="header"><h2><i class="fas fa-laptop-code"></i> 本地 Shell</h2></div>
                <div class="content">
                    <div id="shellNotAvailable" style="display:none;padding:20px;background:var(--color-bg-2);border-radius:8px;margin-bottom:20px">
                        <p style="color:var(--color-warning);margin-bottom:8px"><i class="fas fa-exclamation-triangle"></i> 本地 Shell 服务不可用</p>
                        <p id="shellNotAvailableReason" style="color:var(--color-text-2);font-size:13px">此功能仅支持 Linux 服务器</p>
                    </div>
                    <div class="sftp-status disconnected" id="shellStatus">
                        <div class="status-dot"></div>
                        <span class="sftp-status-text" id="shellStatusText">未启动</span>
                        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                            <span id="shellInfo" style="font-size:12px;color:var(--color-text-3)"></span>
                        </div>
                        <input type="text" id="shellPathInput" placeholder="Shell 名称 (PATH 内，如 bash)" style="width:200px;padding:6px 10px;border:1px solid var(--color-border);border-radius:4px;background:var(--color-bg-2);color:var(--color-text-1);font-size:13px" list="shellPathList">
                        <datalist id="shellPathList">
                            <option value="bash">
                            <option value="zsh">
                            <option value="sh">
                            <option value="fish">
                            <option value="tcsh">
                        </datalist>
                        <button class="btn btn-success btn-sm" id="shellStartBtn"><i class="fas fa-play"></i> 启动</button>
                        <button class="btn btn-danger btn-sm" id="shellStopBtn" style="display:none"><i class="fas fa-stop"></i> 停止</button>
                    </div>
                    <div class="terminal-box">
                        <div class="terminal-header">
                            <div class="terminal-dot red"></div>
                            <div class="terminal-dot yellow"></div>
                            <div class="terminal-dot green"></div>
                            <span class="terminal-title" id="shellTermTitle">本地终端 - 未启动</span>
                            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                                <button class="btn btn-sm btn-secondary" id="shellClearBtn"><i class="fas fa-eraser"></i> 清屏</button>
                            </div>
                        </div>
                        <div id="shellTerminal"></div>
                    </div>
                </div>
            </div>

            <!-- SFTP -->
            <div class="view" id="view-sftp">
                <div class="header"><h2><i class="fas fa-folder-tree"></i> SFTP 管理</h2></div>
                <div class="content">
                    <div class="toolbar">
                        <div class="input-group">
                            <label>主机地址</label>
                            <input type="text" class="form-input" id="sftpHost" placeholder="192.168.1.100">
                        </div>
                        <div class="input-group">
                            <label>端口</label>
                            <input type="number" class="form-input" id="sftpPort" value="22" style="width:70px">
                        </div>
                        <div class="input-group">
                            <label>用户名</label>
                            <input type="text" class="form-input" id="sftpUser" placeholder="root">
                        </div>
                        <div class="input-group">
                            <label>认证方式</label>
                            <select class="form-input" id="sftpAuthType">
                                <option value="password" selected>密码</option>
                                <option value="key">私钥</option>
                            </select>
                        </div>
                        <div class="input-group" id="sftpPasswordGroup">
                            <label>密码</label>
                            <input type="password" class="form-input" id="sftpPass" placeholder="密码" maxlength="2048">
                        </div>
                        <div class="auth-key-panel" id="sftpKeyPanel">
                            <div class="input-group key-input-group">
                                <label>私钥</label>
                                <textarea class="form-input key-input" id="sftpPrivateKey" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----" maxlength="65536" spellcheck="false"></textarea>
                            </div>
                            <div class="input-group">
                                <label>私钥口令（可选）</label>
                                <input type="password" class="form-input" id="sftpPassphrase" placeholder="私钥口令" maxlength="4096">
                            </div>
                        </div>
                        <div class="input-group" style="justify-content:flex-end">
                            <label>&nbsp;</label>
                            <button class="btn btn-success" id="sftpConnectBtn"><i class="fas fa-plug"></i> 连接</button>
                        </div>
                    </div>
                    <div class="sftp-status disconnected" id="sftpStatus">
                        <div class="status-dot"></div>
                        <span class="sftp-status-text" id="sftpStatusText">未连接</span>
                        <button class="btn btn-danger btn-sm" id="sftpDisconnectBtn" style="display:none"><i class="fas fa-times"></i> 断开</button>
                    </div>
                    <div class="file-pane">
                        <div class="file-pane-header">
                            <h3><i class="fas fa-server"></i> 远程文件</h3>
                            <div class="file-pane-actions">
                                <button class="btn btn-sm btn-secondary" id="sftpRefreshBtn" disabled><i class="fas fa-sync-alt"></i> 刷新</button>
                                <button class="btn btn-sm btn-secondary" id="sftpMkdirBtn" disabled><i class="fas fa-folder-plus"></i> 新建</button>
                                <button class="btn btn-sm btn-success" id="sftpDownloadBtn" disabled><i class="fas fa-download"></i> 下载</button>
                                <button class="btn btn-sm btn-danger" id="sftpDeleteBtn" disabled><i class="fas fa-trash"></i> 删除</button>
                            </div>
                        </div>
                        <div class="file-path">
                            <button class="file-path-btn" id="navBackBtn" title="后退" disabled><i class="fas fa-arrow-left"></i></button>
                            <button class="file-path-btn" id="navForwardBtn" title="前进" disabled><i class="fas fa-arrow-right"></i></button>
                            <button class="file-path-btn" id="navUpBtn" title="上级目录"><i class="fas fa-level-up-alt"></i></button>
                            <i class="fas fa-folder-open" style="margin-left:8px"></i>
                            <input type="text" class="file-path-input" id="remotePath" value="/">
                            <button class="file-path-btn" id="goPathBtn" title="跳转"><i class="fas fa-arrow-right"></i></button>
                        </div>
                        <div class="file-list-header">
                            <span></span><span>名称 <small style="color:var(--color-text-3);font-weight:normal">(Ctrl+点击多选)</small></span><span style="text-align:right">大小</span><span>修改时间 <span id="selectedCount" style="color:var(--color-accent);margin-left:8px"></span></span>
                        </div>
                        <div class="file-list" id="fileList">
                            <div class="empty"><i class="fas fa-plug"></i><p>请先连接服务器</p></div>
                        </div>
                    </div>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>拖拽文件到此处，或点击下方按钮上传</p>
                        <div class="upload-btns">
                            <button class="btn" id="uploadFilesBtn" disabled><i class="fas fa-file-upload"></i> 上传文件</button>
                            <button class="btn btn-secondary" id="uploadFolderBtn" disabled><i class="fas fa-folder-upload"></i> 上传文件夹</button>
                        </div>
                        <div class="upload-progress" id="uploadProgress">
                            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                            <div class="progress-text" id="progressText">上传中...</div>
                        </div>
                    </div>
                    <input type="file" class="hidden-input" id="fileInput" multiple>
                    <input type="file" class="hidden-input" id="folderInput" webkitdirectory directory multiple>
                </div>
            </div>

            <!-- VNC -->
            <div class="view" id="view-vnc">
                <div class="header"><h2><i class="fas fa-desktop"></i> VNC 远程桌面</h2></div>
                <div class="content">
                    <div class="toolbar">
                        <div class="input-group">
                            <label>VNC 主机</label>
                            <input type="text" class="form-input" id="vncHost" placeholder="192.168.1.100">
                        </div>
                        <div class="input-group">
                            <label>端口</label>
                            <input type="number" class="form-input" id="vncPort" value="5900" style="width:80px">
                        </div>
                        <div class="input-group">
                            <label>密码</label>
                            <input type="password" class="form-input" id="vncPassword" placeholder="VNC 密码（可选）">
                        </div>
                        <div class="input-group" style="justify-content:flex-end">
                            <label>&nbsp;</label>
                            <button class="btn btn-success" id="vncConnectBtn"><i class="fas fa-plug"></i> 连接</button>
                        </div>
                    </div>
                    <div class="sftp-status disconnected" id="vncStatus">
                        <div class="status-dot"></div>
                        <span class="sftp-status-text" id="vncStatusText">未连接</span>
                        <div style="margin-left:auto;display:flex;gap:8px">
                            <label style="font-size:12px;color:var(--color-text-2);display:flex;align-items:center;gap:4px">
                                <input type="checkbox" id="vncViewOnly"> 只读模式
                            </label>
                            <label style="font-size:12px;color:var(--color-text-2);display:flex;align-items:center;gap:4px">
                                <input type="checkbox" id="vncScaleViewport" checked> 缩放适应
                            </label>
                        </div>
                        <button class="btn btn-danger btn-sm" id="vncDisconnectBtn" style="display:none"><i class="fas fa-times"></i> 断开</button>
                    </div>
                    <div class="vnc-container" id="vncContainer">
                        <div class="vnc-toolbar" id="vncToolbar" style="display:none">
                            <button class="btn btn-sm btn-secondary" id="vncCtrlAltDelBtn" title="Ctrl+Alt+Del"><i class="fas fa-keyboard"></i> Ctrl+Alt+Del</button>
                            <button class="btn btn-sm btn-secondary" id="vncFullscreenBtn" title="全屏"><i class="fas fa-expand"></i></button>
                        </div>
                        <div class="vnc-screen" id="vncScreen">
                            <div class="vnc-placeholder">
                                <i class="fas fa-desktop"></i>
                                <p>请连接到 VNC 服务器</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security -->
            <div class="view" id="view-security">
                <div class="header"><h2><i class="fas fa-shield-halved"></i> 内网白名单</h2></div>
                <div class="content">
                    <div style="padding:12px 16px;border:1px solid var(--color-border);background:var(--color-bg-2);border-radius:8px;margin-bottom:16px;color:var(--color-text-2);font-size:13px">
                        仅允许私有网段（如 10.0.0.0/8、192.168.0.0/16）用于 SSH/SFTP/VNC 连接。修改后立即生效。
                    </div>
                    <div class="toolbar">
                        <div class="input-group">
                            <label>新增网段 (CIDR)</label>
                            <input type="text" class="form-input" id="privateNetInput" placeholder="192.168.0.0/16">
                        </div>
                        <div class="input-group" style="justify-content:flex-end">
                            <label>&nbsp;</label>
                            <button class="btn" id="privateNetAddBtn"><i class="fas fa-plus"></i> 添加</button>
                        </div>
                    </div>
                    <div class="hosts-section">
                        <h3>当前白名单</h3>
                        <div class="hosts-grid" id="privateNetList"></div>
                    </div>
                </div>
            </div>

            <!-- Serial -->
            <div class="view" id="view-serial">
                <div class="header"><h2><i class="fas fa-microchip"></i> 串口终端</h2></div>
                <div class="content">
                    <div class="toolbar">
                        <div class="input-group">
                            <label>波特率</label>
                            <select class="form-input" id="serialBaudRate" style="width:120px">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600">57600</option>
                                <option value="115200" selected>115200</option>
                                <option value="230400">230400</option>
                                <option value="460800">460800</option>
                                <option value="921600">921600</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>数据位</label>
                            <select class="form-input" id="serialDataBits" style="width:80px">
                                <option value="7">7</option>
                                <option value="8" selected>8</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>停止位</label>
                            <select class="form-input" id="serialStopBits" style="width:80px">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>校验位</label>
                            <select class="form-input" id="serialParity" style="width:100px">
                                <option value="none" selected>无</option>
                                <option value="even">偶校验</option>
                                <option value="odd">奇校验</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>流控制</label>
                            <select class="form-input" id="serialFlowControl" style="width:120px">
                                <option value="none" selected>无</option>
                                <option value="hardware">硬件</option>
                            </select>
                        </div>
                        <div class="input-group" style="justify-content:flex-end">
                            <label>&nbsp;</label>
                            <button class="btn btn-success" id="serialConnectBtn"><i class="fas fa-plug"></i> 连接串口</button>
                            <button class="btn btn-secondary" id="serialDemoBtn" title="模拟数据演示"><i class="fas fa-flask"></i> 演示</button>
                        </div>
                    </div>
                    <div class="sftp-status disconnected" id="serialStatus">
                        <div class="status-dot"></div>
                        <span class="sftp-status-text" id="serialStatusText">未连接</span>
                        <button class="btn btn-sm btn-secondary" id="serialWaveformBtn" title="波形显示"><i class="fas fa-chart-line"></i> 波形</button>
                        <button class="btn btn-sm btn-secondary" id="serialStatChartBtn" title="统计图"><i class="fas fa-chart-bar"></i> 统计</button>
                        <button class="btn btn-danger btn-sm" id="serialDisconnectBtn" style="display:none"><i class="fas fa-times"></i> 断开</button>
                    </div>
                    <!-- Waveform Visualization Container -->
                    <div class="waveform-container" id="waveformContainer">
                        <div class="waveform-header">
                            <h4><i class="fas fa-chart-line"></i> 波形显示</h4>
                            <div class="waveform-controls">
                                <label>窗口大小: <input type="number" id="waveformWindowSize" value="200" min="50" max="1000" step="50"></label>
                                <button class="btn btn-sm btn-secondary" id="waveformPauseBtn"><i class="fas fa-pause"></i></button>
                                <button class="btn btn-sm btn-secondary" id="waveformClearBtn"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="waveform-chart-wrapper">
                            <canvas id="waveformCanvas"></canvas>
                            <div class="waveform-legend" id="waveformLegend"></div>
                        </div>
                    </div>
                    <!-- Stat Chart Visualization Container -->
                    <div class="statchart-container" id="statChartContainer">
                        <div class="statchart-header">
                            <h4><i class="fas fa-chart-bar"></i> 统计图</h4>
                            <div class="statchart-controls">
                                <button class="btn btn-sm btn-secondary" id="statChartClearBtn"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="statchart-chart-wrapper">
                            <canvas id="statChartCanvas"></canvas>
                        </div>
                    </div>
                    <div id="serialNotSupported" style="display:none;padding:20px;background:var(--color-bg-2);border-radius:8px;margin-bottom:20px">
                        <p style="color:var(--color-warning);margin-bottom:8px"><i class="fas fa-exclamation-triangle"></i> 浏览器不支持 Web Serial API</p>
                        <p style="color:var(--color-text-2);font-size:13px">请使用 Chrome 89+ 或 Edge 89+ 浏览器，并确保使用 HTTPS 或 localhost 访问。</p>
                    </div>
                    <div class="terminal-box">
                        <div class="terminal-header">
                            <div class="terminal-dot red"></div>
                            <div class="terminal-dot yellow"></div>
                            <div class="terminal-dot green"></div>
                            <span class="terminal-title" id="serialTermTitle">串口终端 - 未连接</span>
                            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                                <label style="font-size:12px;color:var(--color-text-2)">
                                    <input type="checkbox" id="serialAutoScroll" checked> 自动滚动
                                </label>
                                <label style="font-size:12px;color:var(--color-text-2)">
                                    <input type="checkbox" id="serialShowHex"> HEX显示
                                </label>
                                <button class="btn btn-sm btn-secondary" id="serialClearBtn"><i class="fas fa-eraser"></i> 清屏</button>
                            </div>
                        </div>
                        <div id="serialTerminal"></div>
                    </div>
                    <div class="toolbar" style="margin-top:16px">
                        <div class="input-group" style="flex:1">
                            <label>发送数据</label>
                            <div style="display:flex;gap:8px">
                                <input type="text" class="form-input" id="serialSendInput" placeholder="输入要发送的数据..." style="flex:1">
                                <select class="form-input" id="serialSendMode" style="width:100px">
                                    <option value="text">文本</option>
                                    <option value="hex">HEX</option>
                                </select>
                                <select class="form-input" id="serialLineEnding" style="width:100px">
                                    <option value="">无</option>
                                    <option value="\n" selected>LF (\\n)</option>
                                    <option value="\r">CR (\\r)</option>
                                    <option value="\r\n">CRLF (\\r\\n)</option>
                                </select>
                                <button class="btn" id="serialSendBtn" disabled><i class="fas fa-paper-plane"></i> 发送</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal: 新建文件夹 -->
    <div class="modal-overlay" id="mkdirModal">
        <div class="modal">
            <h3><i class="fas fa-folder-plus"></i> 新建文件夹</h3>
            <div class="form-group">
                <label>文件夹名称</label>
                <input type="text" class="form-input" id="mkdirName" placeholder="新文件夹">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="mkdirCancel">取消</button>
                <button class="btn" id="mkdirConfirm">创建</button>
            </div>
        </div>
    </div>

    <!-- Modal: 杀进程 -->
    <div class="modal-overlay" id="killModal">
        <div class="modal">
            <h3><i class="fas fa-skull-crossbones"></i> 终止进程</h3>
            <input type="hidden" id="killPid">
            <div class="form-group">
                <label>进程信息</label>
                <div class="kill-process-info">
                    <div class="kill-info-row"><span>PID:</span> <strong id="killPidDisplay">--</strong></div>
                    <div class="kill-info-row"><span>用户:</span> <strong id="killUserDisplay">--</strong></div>
                    <div class="kill-info-row"><span>命令:</span> <code id="killCmdDisplay">--</code></div>
                </div>
            </div>
            <div class="form-group">
                <label>选择信号</label>
                <div class="signal-options">
                    <label class="signal-option">
                        <input type="radio" name="killSignal" value="15" checked>
                        <span class="signal-label">
                            <strong>SIGTERM (15)</strong>
                            <small>优雅终止，允许进程清理</small>
                        </span>
                    </label>
                    <label class="signal-option">
                        <input type="radio" name="killSignal" value="9">
                        <span class="signal-label">
                            <strong>SIGKILL (9)</strong>
                            <small>强制终止，立即杀死进程</small>
                        </span>
                    </label>
                    <label class="signal-option">
                        <input type="radio" name="killSignal" value="2">
                        <span class="signal-label">
                            <strong>SIGINT (2)</strong>
                            <small>中断信号，类似 Ctrl+C</small>
                        </span>
                    </label>
                    <label class="signal-option">
                        <input type="radio" name="killSignal" value="1">
                        <span class="signal-label">
                            <strong>SIGHUP (1)</strong>
                            <small>挂起信号，常用于重载配置</small>
                        </span>
                    </label>
                    <label class="signal-option">
                        <input type="radio" name="killSignal" value="19">
                        <span class="signal-label">
                            <strong>SIGSTOP (19)</strong>
                            <small>暂停进程</small>
                        </span>
                    </label>
                    <label class="signal-option">
                        <input type="radio" name="killSignal" value="18">
                        <span class="signal-label">
                            <strong>SIGCONT (18)</strong>
                            <small>继续已暂停的进程</small>
                        </span>
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="killCancel">取消</button>
                <button class="btn btn-danger" id="killConfirm"><i class="fas fa-skull"></i> 发送信号</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script type="module">
        // 加载 noVNC RFB
        import RFB from 'https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/core/rfb.js';
        window.RFB = RFB;
    </script>
    <script src="vnc-client.js"></script>
    <script>
    (function() {
        'use strict';

        const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const Config = {
            API: location.origin,
            WS_BASE: `${wsProtocol}//${location.host}`
        };

        const State = {
            loggedIn: false,
            isAdmin: false,
            username: '',
            token: '',
            hosts: [],
            sshConnected: false,
            sftpConnected: false,
            sftpSession: null,
            currentPath: '/',
            selectedFiles: [],
            filesTransferred: 0,
            theme: 'dark',
            // 导航历史
            navHistory: [],
            navIndex: -1
        };

        const Storage = {
            getTheme() { return localStorage.getItem('theme') || 'dark'; },
            setTheme(t) { localStorage.setItem('theme', t); },
            getToken() { return localStorage.getItem('authToken') || ''; },
            setToken(t) { localStorage.setItem('authToken', t); },
            clearToken() { localStorage.removeItem('authToken'); }
        };

        function buildWsUrl(path) {
            const url = new URL(path, Config.WS_BASE);
            if (State.token) {
                url.searchParams.set('token', State.token);
            }
            return url.toString();
        }

        async function apiFetch(url, options = {}) {
            const headers = { ...(options.headers || {}) };
            if (State.token) {
                headers.Authorization = `Bearer ${State.token}`;
            }
            const res = await fetch(url, { ...options, headers });
            if (res.status === 401) {
                Auth.handleUnauthorized();
            }
            return res;
        }

        const AUTH_TYPE_PASSWORD = 'password';
        const AUTH_TYPE_KEY = 'key';

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function normalizeAuthType(authType, privateKey = '') {
            const lowered = String(authType || '').trim().toLowerCase();
            if (lowered === AUTH_TYPE_KEY || lowered === 'privatekey' || lowered === 'private_key') {
                return AUTH_TYPE_KEY;
            }
            if (lowered === AUTH_TYPE_PASSWORD || lowered === 'pass') {
                return AUTH_TYPE_PASSWORD;
            }
            return privateKey ? AUTH_TYPE_KEY : AUTH_TYPE_PASSWORD;
        }

        function isValidPrivateKey(privateKey) {
            return /^-----BEGIN [A-Z0-9 ]*PRIVATE KEY-----[\s\S]+-----END [A-Z0-9 ]*PRIVATE KEY-----$/.test(privateKey);
        }

        function updateAuthFields(prefix, authType) {
            const normalized = normalizeAuthType(authType);
            const passwordGroup = document.getElementById(`${prefix}PasswordGroup`);
            const keyPanel = document.getElementById(`${prefix}KeyPanel`);
            if (passwordGroup) {
                passwordGroup.style.display = normalized === AUTH_TYPE_KEY ? 'none' : '';
            }
            if (keyPanel) {
                keyPanel.classList.toggle('active', normalized === AUTH_TYPE_KEY);
            }
        }

        function readCredentialForm(prefix, options = {}) {
            const requireCredential = options.requireCredential !== false;
            const authTypeRaw = document.getElementById(`${prefix}AuthType`)?.value || AUTH_TYPE_PASSWORD;
            const password = document.getElementById(`${prefix}Pass`)?.value || '';
            const privateKey = (document.getElementById(`${prefix}PrivateKey`)?.value || '')
                .replace(/\r\n/g, '\n')
                .trim();
            const passphrase = document.getElementById(`${prefix}Passphrase`)?.value || '';
            const authType = normalizeAuthType(authTypeRaw, privateKey);
            if (!requireCredential && authType === AUTH_TYPE_PASSWORD && !password) {
                return {};
            }

            if (authType === AUTH_TYPE_KEY) {
                if (!privateKey) {
                    throw new Error('密钥登录需要提供私钥');
                }
                if (!isValidPrivateKey(privateKey)) {
                    throw new Error('私钥格式无效，仅支持 PEM/OpenSSH 私钥');
                }
                const payload = { authType: AUTH_TYPE_KEY, privateKey };
                if (passphrase) {
                    payload.passphrase = passphrase;
                }
                return payload;
            }

            if (!password && requireCredential) {
                throw new Error('密码登录需要提供密码');
            }

            const payload = { authType: AUTH_TYPE_PASSWORD };
            if (password) {
                payload.password = password;
            }
            return payload;
        }

        function getHostCredentialPayload(host, options = {}) {
            const requireCredential = options.requireCredential !== false;
            const privateKey = String(host.privateKey || '').replace(/\r\n/g, '\n').trim();
            const password = host.pass || host.password || '';
            const passphrase = host.passphrase || '';
            const authType = normalizeAuthType(host.authType, privateKey);
            const hasCredential = Boolean(password || privateKey);

            if (!requireCredential && !hasCredential) {
                return {};
            }

            if (authType === AUTH_TYPE_KEY) {
                if (!privateKey) {
                    throw new Error('主机未保存私钥，请先补充');
                }
                return passphrase
                    ? { authType: AUTH_TYPE_KEY, privateKey, passphrase }
                    : { authType: AUTH_TYPE_KEY, privateKey };
            }

            if (!password && requireCredential) {
                throw new Error('主机未保存密码，请先补充');
            }

            return password
                ? { authType: AUTH_TYPE_PASSWORD, password }
                : { authType: AUTH_TYPE_PASSWORD };
        }

        function fillCredentialForm(prefix, host) {
            const privateKey = host.privateKey || '';
            const authType = normalizeAuthType(host.authType, privateKey);
            const authTypeEl = document.getElementById(`${prefix}AuthType`);
            if (authTypeEl) {
                authTypeEl.value = authType;
            }
            const passEl = document.getElementById(`${prefix}Pass`);
            if (passEl) {
                passEl.value = host.pass || host.password || '';
            }
            const privateKeyEl = document.getElementById(`${prefix}PrivateKey`);
            if (privateKeyEl) {
                privateKeyEl.value = privateKey;
            }
            const passphraseEl = document.getElementById(`${prefix}Passphrase`);
            if (passphraseEl) {
                passphraseEl.value = host.passphrase || '';
            }
            updateAuthFields(prefix, authType);
        }

        // 主题
        const Theme = {
            init() {
                State.theme = Storage.getTheme();
                this.apply();
                document.getElementById('themeToggle').addEventListener('click', () => this.toggle());
            },
            apply() {
                document.documentElement.setAttribute('data-theme', State.theme);
                const icon = document.querySelector('#themeToggle i');
                icon.className = State.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            },
            toggle() {
                State.theme = State.theme === 'dark' ? 'light' : 'dark';
                Storage.setTheme(State.theme);
                this.apply();
            }
        };

        const Toast = {
            show(msg, type = 'info') {
                const el = document.createElement('div');
                el.className = `toast ${type}`;
                el.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i><span>${escapeHtml(msg)}</span>`;
                document.getElementById('toasts').appendChild(el);
                setTimeout(() => { el.style.animation = 'slideIn .3s reverse'; setTimeout(() => el.remove(), 300); }, 3500);
            },
            success(m) { this.show(m, 'success'); },
            error(m) { this.show(m, 'error'); },
            info(m) { this.show(m, 'info'); }
        };

        const Auth = {
            getToken() {
                return State.token || Storage.getToken();
            },
            init() {
                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                document.getElementById('loginPass').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());

                const savedToken = Storage.getToken();
                if (savedToken) {
                    State.token = savedToken;
                    this.verify();
                } else {
                    this.showLogin();
                }
            },
            async login() {
                const username = document.getElementById('loginUser').value.trim();
                const password = document.getElementById('loginPass').value;
                if (!username || !password) {
                    this.showError('请输入用户名和密码');
                    return;
                }
                this.showError('');
                try {
                    const res = await fetch(`${Config.API}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        this.setSession(data);
                        document.getElementById('loginPass').value = '';
                        this.hideLogin();
                        UI.showDashboard();
                    } else {
                        this.showError(data.error || '登录失败');
                    }
                } catch (err) {
                    this.showError(`登录失败: ${err.message}`);
                }
            },
            async verify() {
                try {
                    const res = await apiFetch(`${Config.API}/api/auth/verify`, { method: 'POST' });
                    if (res.ok) {
                        const data = await res.json();
                        this.setSession({ token: State.token, ...data });
                        this.hideLogin();
                        UI.showDashboard();
                        return;
                    }
                } catch {}
                this.clearSession();
                this.showLogin();
            },
            setSession({ token, username, role }) {
                if (token) {
                    State.token = token;
                    Storage.setToken(token);
                }
                State.loggedIn = true;
                State.username = username || State.username;
                State.isAdmin = role === 'admin';
            },
            clearSession() {
                State.loggedIn = false;
                State.isAdmin = false;
                State.username = '';
                State.token = '';
                State.hosts = [];
                State.navHistory = [];
                State.navIndex = -1;
                State.selectedFiles = [];
                Storage.clearToken();
                UI.resetConnections();
                UI.hideDashboard();
            },
            logout() {
                this.clearSession();
                this.showLogin();
                Toast.info('已退出登录');
            },
            handleUnauthorized() {
                if (State.loggedIn) {
                    Toast.error('登录已过期，请重新登录');
                }
                this.clearSession();
                this.showLogin();
            },
            showLogin() {
                document.getElementById('authOverlay').classList.remove('hidden');
                document.getElementById('loginPass').value = '';
                document.getElementById('loginUser').focus();
            },
            hideLogin() {
                document.getElementById('authOverlay').classList.add('hidden');
                this.showError('');
            },
            showError(msg) {
                document.getElementById('authError').textContent = msg || '';
            }
        };

        window.Auth = Auth;

        // 终端
        const Terminal_ = {
            term: null, fit: null, ws: null, host: null,
            // System stats monitoring
            statsActive: false,      // 是否正在采集数据
            chartExpanded: false,    // 图表是否展开
            statsVisualizer: null,
            lastCpuStat: null,
            // TOP panel
            topActive: false,        // TOP是否正在采集
            topExpanded: false,      // TOP面板是否展开
            topProcesses: [],        // 进程列表
            topSortField: 'cpu',     // 排序字段
            topSortDesc: true,       // 降序
            init() {
                this.term = new Terminal({
                    theme: {
                        background: '#1a1a1a', foreground: '#fff', cursor: '#0078D7',
                        selection: 'rgba(0,120,215,0.3)',
                        black: '#1a1a1a', red: '#e81123', green: '#107c10', yellow: '#ff8c00',
                        blue: '#0078D7', magenta: '#881798', cyan: '#3a96dd', white: '#ccc'
                    },
                    fontFamily: 'Consolas, Monaco, monospace',
                    fontSize: 14, cursorBlink: true
                });
                this.fit = new FitAddon.FitAddon();
                this.term.loadAddon(this.fit);
                this.term.open(document.getElementById('terminal'));
                this.doFit();
                this.welcome();
                window.addEventListener('resize', () => this.doFit());
                this.term.onData(data => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({ type: 'data', data }));
                    }
                });
                this.term.onResize(({ cols, rows }) => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({ type: 'resize', cols, rows }));
                    }
                });
            },
            doFit() { try { this.fit.fit(); } catch {} },
            welcome() {
                this.term.writeln('');
                this.term.writeln('\x1b[1;34m  ╔══════════════════════════════════════════╗\x1b[0m');
                this.term.writeln('\x1b[1;34m  ║\x1b[0m          \x1b[1;36mEntrance Tools\x1b[0m                  \x1b[1;34m║\x1b[0m');
                this.term.writeln('\x1b[1;34m  ╚══════════════════════════════════════════╝\x1b[0m');
                this.term.writeln('');
                this.term.writeln('\x1b[90m  输入连接信息后点击 SSH 按钮连接服务器\x1b[0m');
                this.term.writeln('');
            },
            connect(host, port, user, authPayload = {}) {
                if (this.ws) this.ws.close();
                this.term.clear();
                this.term.writeln(`\x1b[33m正在连接 ${user}@${host}:${port}...\x1b[0m\n`);
                this.ws = new WebSocket(buildWsUrl('/ssh'));
                this.ws.onopen = () => {
                    this.ws.send(JSON.stringify({
                        type: 'connect',
                        host,
                        port: +port,
                        username: user,
                        ...authPayload
                    }));
                };
                this.ws.onmessage = (e) => {
                    const msg = JSON.parse(e.data);
                    switch (msg.type) {
                        case 'connected':
                            State.sshConnected = true;
                            this.host = host;
                            this.updateStatus(true);
                            Toast.success(`已连接到 ${host}`);
                            this.doFit();
                            // 自动开始采集系统数据
                            this.startStats();
                            // 自动开始采集TOP数据
                            this.startTop();
                            break;
                        case 'data': this.term.write(msg.data); break;
                        case 'stats': this.handleStats(msg.data); break;
                        case 'top': this.handleTop(msg.data); break;
                        case 'killResult': this.handleKillResult(msg.data); break;
                        case 'error':
                            this.term.writeln(`\x1b[31m错误: ${msg.message}\x1b[0m`);
                            Toast.error(msg.message);
                            break;
                        case 'disconnected':
                            State.sshConnected = false;
                            this.host = null;
                            this.stopStats();
                            this.stopTop();
                            this.updateStatus(false);
                            this.term.writeln('\n\x1b[33m连接已断开\x1b[0m');
                            Toast.info('SSH 连接已断开');
                            break;
                    }
                };
                this.ws.onerror = () => {
                    this.term.writeln('\x1b[31m连接失败，请确保后端服务正在运行\x1b[0m');
                    Toast.error('WebSocket 连接失败');
                };
                this.ws.onclose = () => {
                    if (State.sshConnected) {
                        State.sshConnected = false;
                        this.updateStatus(false);
                    }
                };
            },
            updateStatus(connected) {
                const status = document.getElementById('termStatus');
                const title = document.getElementById('termTitle');
                if (connected) {
                    status.className = 'terminal-status connected';
                    status.innerHTML = '<i class="fas fa-circle"></i><span>已连接</span>';
                    title.textContent = `终端 - ${this.host}`;
                } else {
                    status.className = 'terminal-status disconnected';
                    status.innerHTML = '<i class="fas fa-circle"></i><span>未连接</span>';
                    title.textContent = '终端 - 未连接';
                }
            },
            // Start stats collection (called on SSH connect)
            startStats() {
                if (this.statsActive) return;

                // Initialize visualizer if needed
                if (!this.statsVisualizer) {
                    this.statsVisualizer = new SysStatsVisualizer('sysStatsCanvas');
                }
                this.statsActive = true;

                // Start stats collection on server
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'startStats' }));
                }
            },
            // Toggle chart expansion (show/hide waveform)
            toggleStats() {
                if (!State.sshConnected) {
                    Toast.error('请先连接 SSH');
                    return;
                }
                const container = document.getElementById('sysStatsContainer');

                this.chartExpanded = !this.chartExpanded;
                if (this.chartExpanded) {
                    container.classList.add('active');
                } else {
                    container.classList.remove('active');
                }
            },
            // Stop stats collection (called on SSH disconnect)
            stopStats() {
                const container = document.getElementById('sysStatsContainer');

                this.statsActive = false;
                this.chartExpanded = false;
                this.lastCpuStat = null;
                container.classList.remove('active');

                // Reset display values
                document.getElementById('statCpuValue').textContent = '--%';
                document.getElementById('statMemValue').textContent = '--%';
                document.getElementById('statDiskValue').textContent = '-- KB/s';

                // Stop stats collection on server
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'stopStats' }));
                }
            },
            // Clear stats data
            clearStats() {
                if (this.statsVisualizer) {
                    this.statsVisualizer.clear();
                }
                this.lastCpuStat = null;
            },
            // Handle stats data from server
            handleStats(data) {
                if (!this.statsVisualizer) return;

                const currentTime = Date.now();

                // Parse CPU stats
                let cpuPercent = 0;
                if (data.stat) {
                    const cpuStat = this.statsVisualizer.parseCpuStat(data.stat.split('\n'));
                    if (cpuStat && this.lastCpuStat) {
                        const totalDelta = cpuStat.total - this.lastCpuStat.total;
                        const busyDelta = cpuStat.busy - this.lastCpuStat.busy;
                        if (totalDelta > 0) {
                            cpuPercent = (busyDelta / totalDelta) * 100;
                        }
                    }
                    this.lastCpuStat = cpuStat;
                }

                // Parse memory stats
                let memPercent = 0;
                if (data.meminfo) {
                    const mem = this.statsVisualizer.parseMemInfo(data.meminfo.split('\n'));
                    if (mem !== null) {
                        memPercent = parseFloat(mem);
                    }
                }

                // Parse disk stats
                let diskRead = 0, diskWrite = 0;
                if (data.diskstats) {
                    const disk = this.statsVisualizer.parseDiskStats(data.diskstats.split('\n'), currentTime);
                    if (disk) {
                        diskRead = disk.read;
                        diskWrite = disk.write;
                    }
                }

                // Update display values (always, for the hint bar)
                if (this.lastCpuStat) {
                    document.getElementById('statCpuValue').textContent = cpuPercent.toFixed(1) + '%';
                    document.getElementById('statMemValue').textContent = memPercent.toFixed(1) + '%';
                    document.getElementById('statDiskValue').textContent = (diskRead + diskWrite).toFixed(1) + ' KB/s';

                    // Push data to chart
                    this.statsVisualizer.pushData(cpuPercent, memPercent, diskRead, diskWrite);
                }
            },
            // Start TOP data collection
            startTop() {
                if (this.topActive) return;
                this.topActive = true;
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'startTop' }));
                }
            },
            // Stop TOP data collection
            stopTop() {
                const container = document.getElementById('topPanelContainer');
                this.topActive = false;
                this.topExpanded = false;
                this.topProcesses = [];
                container.classList.remove('active');
                // Reset hint values
                document.getElementById('topProcsValue').textContent = '--';
                document.getElementById('topRunningValue').textContent = '--';
                document.getElementById('topLoadValue').textContent = '--';
                // Reset summary
                document.getElementById('topUptime').textContent = '--';
                document.getElementById('topUsers').textContent = '--';
                document.getElementById('topLoadAvg').textContent = '--';
                document.getElementById('topTasks').textContent = '--';
                document.getElementById('topCpuUsage').textContent = '--';
                document.getElementById('topMemUsage').textContent = '--';
                // Clear table
                document.getElementById('topTableBody').innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--color-text-3);padding:20px">连接SSH后自动获取进程信息</td></tr>';
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'stopTop' }));
                }
            },
            // Toggle TOP panel expansion
            toggleTop() {
                if (!State.sshConnected) {
                    Toast.error('请先连接 SSH');
                    return;
                }
                const container = document.getElementById('topPanelContainer');
                this.topExpanded = !this.topExpanded;
                container.classList.toggle('active', this.topExpanded);
            },
            // Refresh TOP data manually
            refreshTop() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN && State.sshConnected) {
                    this.ws.send(JSON.stringify({ type: 'refreshTop' }));
                }
            },
            // Handle TOP data from server
            handleTop(data) {
                // Parse uptime info
                if (data.uptime) {
                    this.parseUptime(data.uptime);
                }
                // Parse process list (ps aux output)
                if (data.ps) {
                    this.parseProcessList(data.ps);
                    this.renderTopTable();
                }
            },
            // Parse uptime output
            parseUptime(uptimeStr) {
                // Example: " 10:15:03 up 5 days, 12:30,  2 users,  load average: 0.15, 0.10, 0.05"
                const lines = uptimeStr.trim().split('\n');
                const line = lines[0];

                // Extract uptime
                const uptimeMatch = line.match(/up\s+(.+?),\s+\d+\s+user/);
                if (uptimeMatch) {
                    document.getElementById('topUptime').textContent = uptimeMatch[1].trim();
                }

                // Extract users
                const usersMatch = line.match(/(\d+)\s+user/);
                if (usersMatch) {
                    document.getElementById('topUsers').textContent = usersMatch[1];
                }

                // Extract load average
                const loadMatch = line.match(/load average:\s*([\d.]+),\s*([\d.]+),\s*([\d.]+)/);
                if (loadMatch) {
                    document.getElementById('topLoadAvg').textContent = `${loadMatch[1]}, ${loadMatch[2]}, ${loadMatch[3]}`;
                    document.getElementById('topLoadValue').textContent = loadMatch[1];
                }
            },
            // Parse ps aux output
            parseProcessList(psStr) {
                const lines = psStr.trim().split('\n');
                if (lines.length < 2) return;

                // Skip header line
                const processes = [];
                let totalProcs = 0;
                let runningProcs = 0;

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // ps aux format: USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND
                    const parts = line.split(/\s+/);
                    if (parts.length < 11) continue;

                    const proc = {
                        user: parts[0],
                        pid: parseInt(parts[1]),
                        cpu: parseFloat(parts[2]),
                        mem: parseFloat(parts[3]),
                        vsz: parseInt(parts[4]),
                        rss: parseInt(parts[5]),
                        tty: parts[6],
                        stat: parts[7],
                        start: parts[8],
                        time: parts[9],
                        cmd: parts.slice(10).join(' ')
                    };

                    processes.push(proc);
                    totalProcs++;
                    if (proc.stat.startsWith('R')) runningProcs++;
                }

                this.topProcesses = processes;

                // Update hint bar
                document.getElementById('topProcsValue').textContent = totalProcs;
                document.getElementById('topRunningValue').textContent = runningProcs;

                // Update summary
                document.getElementById('topTasks').textContent = `${totalProcs} total, ${runningProcs} running`;

                // Calculate total CPU/MEM
                const totalCpu = processes.reduce((sum, p) => sum + p.cpu, 0);
                const totalMem = processes.reduce((sum, p) => sum + p.mem, 0);
                document.getElementById('topCpuUsage').textContent = totalCpu.toFixed(1) + '%';
                document.getElementById('topMemUsage').textContent = totalMem.toFixed(1) + '%';
            },
            // Render TOP table
            renderTopTable() {
                const tbody = document.getElementById('topTableBody');
                const sortBy = document.getElementById('topSortBy').value;
                const showCount = parseInt(document.getElementById('topShowCount').value);

                // Sort processes
                let sorted = [...this.topProcesses];
                sorted.sort((a, b) => {
                    let va, vb;
                    switch (sortBy) {
                        case 'cpu': va = a.cpu; vb = b.cpu; break;
                        case 'mem': va = a.mem; vb = b.mem; break;
                        case 'pid': va = a.pid; vb = b.pid; break;
                        case 'time': va = a.time; vb = b.time; break;
                        default: va = a.cpu; vb = b.cpu;
                    }
                    return this.topSortDesc ? vb - va : va - vb;
                });

                // Limit to showCount
                sorted = sorted.slice(0, showCount);

                // Render rows
                if (sorted.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--color-text-3);padding:20px">无进程数据</td></tr>';
                    return;
                }

                const escapeHtml = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

                tbody.innerHTML = sorted.map(p => {
                    const cpuBarWidth = Math.min(p.cpu, 100);
                    const memBarWidth = Math.min(p.mem, 100);
                    const escapedCmd = escapeHtml(p.cmd);
                    return `<tr>
                        <td class="col-pid">${p.pid}</td>
                        <td class="col-user">${escapeHtml(p.user)}</td>
                        <td class="col-cpu"><span class="top-cpu-bar" style="width:${cpuBarWidth}px"></span>${p.cpu.toFixed(1)}</td>
                        <td class="col-mem"><span class="top-mem-bar" style="width:${memBarWidth}px"></span>${p.mem.toFixed(1)}</td>
                        <td class="col-vsz">${this.formatSize(p.vsz * 1024)}</td>
                        <td class="col-rss">${this.formatSize(p.rss * 1024)}</td>
                        <td class="col-stat">${p.stat}</td>
                        <td class="col-time">${p.time}</td>
                        <td class="col-cmd" title="${escapedCmd}">${escapedCmd}</td>
                        <td class="col-action"><button class="top-kill-btn" onclick="Terminal_.showKillModal(${p.pid}, '${escapeHtml(p.user)}', '${escapedCmd.replace(/'/g, "\\'")}')"><i class="fas fa-times"></i></button></td>
                    </tr>`;
                }).join('');
            },
            // Show kill process modal
            showKillModal(pid, user, cmd) {
                document.getElementById('killPid').value = pid;
                document.getElementById('killPidDisplay').textContent = pid;
                document.getElementById('killUserDisplay').textContent = user;
                document.getElementById('killCmdDisplay').textContent = cmd;
                document.getElementById('killCmdDisplay').title = cmd;
                // Reset to default signal
                document.querySelector('input[name="killSignal"][value="15"]').checked = true;
                document.getElementById('killModal').classList.add('active');
            },
            // Kill process with selected signal
            killProcess() {
                const pid = document.getElementById('killPid').value;
                const signal = document.querySelector('input[name="killSignal"]:checked').value;
                const signalNames = { '1': 'SIGHUP', '2': 'SIGINT', '9': 'SIGKILL', '15': 'SIGTERM', '18': 'SIGCONT', '19': 'SIGSTOP' };

                if (this.ws && this.ws.readyState === WebSocket.OPEN && State.sshConnected) {
                    this.ws.send(JSON.stringify({ type: 'kill', pid: parseInt(pid), signal: parseInt(signal) }));
                    Toast.info(`正在发送 ${signalNames[signal]} 到 PID ${pid}...`);
                    document.getElementById('killModal').classList.remove('active');
                } else {
                    Toast.error('未连接到SSH');
                }
            },
            // Handle kill result from server
            handleKillResult(data) {
                if (data.success) {
                    Toast.success(data.message || `进程信号已发送`);
                    // Refresh process list
                    this.refreshTop();
                } else {
                    Toast.error(data.message || '操作失败');
                }
            },
            // Format bytes to human readable
            formatSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' K';
                if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + ' M';
                return (bytes / 1024 / 1024 / 1024).toFixed(1) + ' G';
            }
        };
        window.Terminal_ = Terminal_;

        // SFTP
        const SFTP = {
            async connect(host, port, user, authPayload = {}) {
                try {
                    const payload = { host, port: +port, username: user, ...authPayload };
                    const res = await apiFetch(`${Config.API}/api/sftp/connect`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (res.ok) {
                        State.sftpConnected = true;
                        State.sftpSession = data.sessionId;
                        // 重置导航历史
                        State.navHistory = [];
                        State.navIndex = -1;
                        this.updateStatus(true, host);
                        Toast.success(`SFTP 已连接到 ${host}`);
                        await this.getHome();
                        await this.navigate(State.currentPath);
                        this.enableBtns(true);
                    } else {
                        Toast.error(data.error || '连接失败');
                    }
                } catch (e) {
                    Toast.error('连接失败: ' + e.message);
                }
            },
            async disconnect() {
                if (!State.sftpSession) return;
                try { await apiFetch(`${Config.API}/api/sftp/disconnect/${State.sftpSession}`, { method: 'POST' }); } catch {}
                State.sftpConnected = false;
                State.sftpSession = null;
                State.currentPath = '/';
                State.navHistory = [];
                State.navIndex = -1;
                this.updateStatus(false);
                this.enableBtns(false);
                this.updateNavBtns();
                this.renderFiles([]);
                Toast.info('SFTP 已断开');
            },
            async getHome() {
                if (!State.sftpSession) return;
                try {
                    const res = await apiFetch(`${Config.API}/api/sftp/home/${State.sftpSession}`);
                    const data = await res.json();
                    if (res.ok) {
                        State.currentPath = data.path;
                        document.getElementById('remotePath').value = data.path;
                    }
                } catch {}
            },
            // 导航到路径（添加到历史）
            async navigate(path, addToHistory = true) {
                if (!State.sftpSession) return;
                try {
                    const res = await apiFetch(`${Config.API}/api/sftp/list/${State.sftpSession}?path=${encodeURIComponent(path)}`);
                    const data = await res.json();
                    if (res.ok) {
                        State.currentPath = data.path;
                        document.getElementById('remotePath').value = data.path;
                        State.selectedFiles = [];
                        this.renderFiles(data.files);
                        // 添加到历史
                        if (addToHistory) {
                            // 如果不在历史末尾，截断后面的
                            if (State.navIndex < State.navHistory.length - 1) {
                                State.navHistory = State.navHistory.slice(0, State.navIndex + 1);
                            }
                            State.navHistory.push(data.path);
                            State.navIndex = State.navHistory.length - 1;
                        }
                        this.updateNavBtns();
                    } else {
                        Toast.error(data.error);
                    }
                } catch (e) {
                    Toast.error('列表错误: ' + e.message);
                }
            },
            // 后退
            goBack() {
                if (State.navIndex > 0) {
                    State.navIndex--;
                    this.navigate(State.navHistory[State.navIndex], false);
                }
            },
            // 前进
            goForward() {
                if (State.navIndex < State.navHistory.length - 1) {
                    State.navIndex++;
                    this.navigate(State.navHistory[State.navIndex], false);
                }
            },
            // 上级目录
            goUp() {
                const parts = State.currentPath.split('/').filter(p => p);
                parts.pop();
                const parentPath = '/' + parts.join('/');
                this.navigate(parentPath);
            },
            // 更新导航按钮状态
            updateNavBtns() {
                document.getElementById('navBackBtn').disabled = State.navIndex <= 0;
                document.getElementById('navForwardBtn').disabled = State.navIndex >= State.navHistory.length - 1;
            },
            // 更新选中计数
            updateSelectionCount() {
                const count = State.selectedFiles.filter(f => f.name !== '..').length;
                const el = document.getElementById('selectedCount');
                el.textContent = count > 0 ? `已选 ${count} 项` : '';
            },
            async list(path) {
                await this.navigate(path);
            },
            async mkdir(name) {
                if (!State.sftpSession) return;
                const p = State.currentPath === '/' ? `/${name}` : `${State.currentPath}/${name}`;
                try {
                    const res = await apiFetch(`${Config.API}/api/sftp/mkdir/${State.sftpSession}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: p })
                    });
                    if (res.ok) {
                        Toast.success('文件夹创建成功');
                        await this.list(State.currentPath);
                    } else {
                        const d = await res.json();
                        Toast.error(d.error);
                    }
                } catch (e) {
                    Toast.error(e.message);
                }
            },
            async delete_() {
                if (!State.sftpSession || State.selectedFiles.length === 0) return;
                const f = State.selectedFiles[0];
                const p = State.currentPath === '/' ? `/${f.name}` : `${State.currentPath}/${f.name}`;
                try {
                    const res = await apiFetch(`${Config.API}/api/sftp/delete/${State.sftpSession}?path=${encodeURIComponent(p)}&type=${f.type}`, { method: 'DELETE' });
                    if (res.ok) {
                        Toast.success('删除成功');
                        State.selectedFiles = [];
                        await this.list(State.currentPath);
                    } else {
                        const d = await res.json();
                        Toast.error(d.error);
                    }
                } catch (e) {
                    Toast.error(e.message);
                }
            },
            async upload(files) {
                if (!State.sftpSession || files.length === 0) return;
                const form = new FormData();
                const paths = [];
                for (const f of files) {
                    form.append('files', f);
                    paths.push(f.webkitRelativePath || f.name);
                }
                form.append('remotePath', State.currentPath);
                form.append('paths', JSON.stringify(paths));
                this.showProgress(true);
                try {
                    const res = await apiFetch(`${Config.API}/api/sftp/upload/${State.sftpSession}`, { method: 'POST', body: form });
                    const data = await res.json();
                    if (res.ok) {
                        State.filesTransferred += data.results.length;
                        document.getElementById('statFiles').textContent = State.filesTransferred;
                        Toast.success(data.message);
                        if (data.errors.length > 0) data.errors.forEach(e => Toast.error(`失败: ${e.file}`));
                        await this.list(State.currentPath);
                    } else {
                        Toast.error(data.error);
                    }
                } catch (e) {
                    Toast.error(e.message);
                } finally {
                    this.showProgress(false);
                }
            },
            showProgress(show) {
                const el = document.getElementById('uploadProgress');
                document.getElementById('progressFill').style.width = show ? '100%' : '0';
                el.classList.toggle('active', show);
            },
            updateStatus(connected, host = '') {
                const el = document.getElementById('sftpStatus');
                const txt = document.getElementById('sftpStatusText');
                const disconnBtn = document.getElementById('sftpDisconnectBtn');
                const connBtn = document.getElementById('sftpConnectBtn');
                if (connected) {
                    el.classList.remove('disconnected'); el.classList.add('connected');
                    txt.textContent = `已连接到 ${host}`;
                    disconnBtn.style.display = 'inline-flex'; connBtn.disabled = true;
                } else {
                    el.classList.remove('connected'); el.classList.add('disconnected');
                    txt.textContent = '未连接';
                    disconnBtn.style.display = 'none'; connBtn.disabled = false;
                }
            },
            async download() {
                if (!State.sftpSession || State.selectedFiles.length === 0) {
                    Toast.error('请先选择要下载的文件');
                    return;
                }
                // 过滤掉 ".."
                const files = State.selectedFiles.filter(f => f.name !== '..');
                if (files.length === 0) {
                    Toast.error('请选择有效的文件');
                    return;
                }
                // 单个普通文件直接下载
                if (files.length === 1 && files[0].type !== 'folder') {
                    const f = files[0];
                    const filePath = State.currentPath === '/' ? `/${f.name}` : `${State.currentPath}/${f.name}`;
                    try {
                        const res = await apiFetch(`${Config.API}/api/sftp/download/${State.sftpSession}?path=${encodeURIComponent(filePath)}`);
                        if (res.ok) {
                            const blob = await res.blob();
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = f.name;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            Toast.success(`正在下载: ${f.name}`);
                        } else {
                            const data = await res.json();
                            Toast.error(data.error || '下载失败');
                        }
                    } catch (e) {
                        Toast.error('下载失败: ' + e.message);
                    }
                } else {
                    // 多文件或文件夹，打包下载
                    Toast.info(`正在打包 ${files.length} 个项目...`);
                    try {
                        const res = await apiFetch(`${Config.API}/api/sftp/download-zip/${State.sftpSession}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files, basePath: State.currentPath })
                        });
                        if (res.ok) {
                            const blob = await res.blob();
                            const zipName = files.length === 1 ? `${files[0].name}.zip` : `download_${Date.now()}.zip`;
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = zipName;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            Toast.success('下载完成');
                        } else {
                            const data = await res.json();
                            Toast.error(data.error || '下载失败');
                        }
                    } catch (e) {
                        Toast.error('下载失败: ' + e.message);
                    }
                }
            },
            enableBtns(enabled) {
                document.getElementById('sftpRefreshBtn').disabled = !enabled;
                document.getElementById('sftpMkdirBtn').disabled = !enabled;
                document.getElementById('sftpDownloadBtn').disabled = !enabled;
                document.getElementById('sftpDeleteBtn').disabled = !enabled;
                document.getElementById('uploadFilesBtn').disabled = !enabled;
                document.getElementById('uploadFolderBtn').disabled = !enabled;
            },
            renderFiles(files) {
                const el = document.getElementById('fileList');
                if (!files || files.length === 0) {
                    el.innerHTML = State.sftpConnected
                        ? '<div class="empty"><i class="fas fa-folder-open"></i><p>空目录</p></div>'
                        : '<div class="empty"><i class="fas fa-plug"></i><p>请先连接服务器</p></div>';
                    return;
                }
                const items = State.currentPath !== '/' ? [{ name: '..', type: 'folder', size: '', modified: '' }, ...files] : files;
                el.innerHTML = items.map(f => `
                    <div class="file-item" data-name="${f.name}" data-type="${f.type}">
                        <i class="fas ${this.getIcon(f)}"></i>
                        <span class="file-name">${f.name}</span>
                        <span class="file-size">${this.formatSize(f.size)}</span>
                        <span class="file-modified">${this.formatDate(f.modified)}</span>
                    </div>
                `).join('');
                el.querySelectorAll('.file-item').forEach(item => {
                    item.addEventListener('click', e => {
                        if (!e.ctrlKey && !e.shiftKey) el.querySelectorAll('.file-item').forEach(i => i.classList.remove('selected'));
                        item.classList.toggle('selected');
                        State.selectedFiles = [...el.querySelectorAll('.file-item.selected')].map(i => ({ name: i.dataset.name, type: i.dataset.type }));
                        this.updateSelectionCount();
                    });
                    item.addEventListener('dblclick', () => {
                        if (item.dataset.type === 'folder') {
                            let newPath;
                            if (item.dataset.name === '..') {
                                this.goUp();
                            } else {
                                newPath = State.currentPath === '/' ? `/${item.dataset.name}` : `${State.currentPath}/${item.dataset.name}`;
                                this.navigate(newPath);
                            }
                        }
                    });
                });
            },
            getIcon(f) {
                if (f.type === 'folder') return 'fa-folder';
                const ext = f.name.split('.').pop().toLowerCase();
                const map = { js: 'fa-file-code', ts: 'fa-file-code', py: 'fa-file-code', html: 'fa-file-code', css: 'fa-file-code', json: 'fa-file-code', png: 'fa-file-image', jpg: 'fa-file-image', jpeg: 'fa-file-image', gif: 'fa-file-image', zip: 'fa-file-archive', tar: 'fa-file-archive', gz: 'fa-file-archive' };
                return map[ext] || 'fa-file';
            },
            formatSize(b) {
                if (!b) return '-';
                const u = ['B', 'KB', 'MB', 'GB'];
                let i = 0, s = b;
                while (s >= 1024 && i < u.length - 1) { s /= 1024; i++; }
                return `${s.toFixed(1)} ${u[i]}`;
            },
            formatDate(d) {
                if (!d) return '-';
                const dt = new Date(d);
                return `${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            }
        };

        // 主机管理（服务端存储）
        const Hosts = {
            getUserId() {
                return State.username;
            },
            async load() {
                const userId = this.getUserId();
                if (!userId) return;
                try {
                    const res = await apiFetch(`${Config.API}/api/userdata/${userId}/hosts`);
                    const data = await res.json().catch(() => []);
                    if (!res.ok) {
                        State.hosts = [];
                        this.render();
                        Toast.error(data.error || '加载主机列表失败');
                        return;
                    }
                    State.hosts = Array.isArray(data) ? data : [];
                    this.render();
                } catch (e) {
                    console.error('加载主机列表失败:', e);
                    State.hosts = [];
                    this.render();
                }
            },
            async add(h) {
                const userId = this.getUserId();
                if (!userId) return;
                try {
                    const res = await apiFetch(`${Config.API}/api/userdata/${userId}/hosts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(h)
                    });
                    const data = await res.json();
                    if (res.ok) {
                        Toast.success('主机已保存');
                        await this.load();
                    } else {
                        Toast.error(data.error || '保存失败');
                    }
                } catch (e) {
                    Toast.error('保存失败: ' + e.message);
                }
            },
            async remove(i) {
                const userId = this.getUserId();
                if (!userId) return;
                try {
                    const res = await apiFetch(`${Config.API}/api/userdata/${userId}/hosts/${i}`, { method: 'DELETE' });
                    if (res.ok) {
                        Toast.info('主机已删除');
                        await this.load();
                    }
                } catch (e) {
                    Toast.error('删除失败');
                }
            },
            render() {
                const el = document.getElementById('hostsGrid');
                if (!Array.isArray(State.hosts) || State.hosts.length === 0) {
                    el.innerHTML = '<div class="empty"><i class="fas fa-server"></i><p>暂无保存的主机</p></div>';
                    return;
                }
                el.innerHTML = State.hosts.map((h, i) => {
                    const authType = normalizeAuthType(h.authType, h.privateKey || '');
                    const authLabel = authType === AUTH_TYPE_KEY ? '密钥登录' : '密码登录';
                    const hostText = escapeHtml(h.host || '');
                    const userText = escapeHtml(h.user || '');
                    const portText = escapeHtml(h.port || 22);
                    return `
                    <div class="host-card ${Terminal_.host === h.host ? 'connected' : ''}" data-index="${i}">
                        <button class="host-delete" data-index="${i}"><i class="fas fa-times"></i></button>
                        <div class="host-card-content">
                            <div class="host-info"><i class="fas fa-server"></i><span class="host-ip">${hostText}</span></div>
                            <div class="host-details">${userText}@${hostText}:${portText}</div>
                            <span class="host-auth-tag">${authLabel}</span>
                            <div class="host-actions">
                                <button class="btn btn-sm ssh-btn" data-index="${i}"><i class="fas fa-terminal"></i> SSH</button>
                                <button class="btn btn-sm btn-secondary sftp-btn" data-index="${i}"><i class="fas fa-folder"></i> SFTP</button>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
                el.querySelectorAll('.host-delete').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); this.remove(+btn.dataset.index); }));
                el.querySelectorAll('.ssh-btn').forEach(btn => btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const h = State.hosts[+btn.dataset.index];
                    try {
                        const authPayload = getHostCredentialPayload(h);
                        Terminal_.connect(h.host, h.port, h.user, authPayload);
                    } catch (err) {
                        Toast.error(err.message);
                        UI.switchView('ssh');
                        document.getElementById('sshHost').value = h.host || '';
                        document.getElementById('sshPort').value = h.port || 22;
                        document.getElementById('sshUser').value = h.user || '';
                        fillCredentialForm('ssh', h);
                    }
                }));
                el.querySelectorAll('.sftp-btn').forEach(btn => btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const h = State.hosts[+btn.dataset.index];
                    UI.switchView('sftp');
                    document.getElementById('sftpHost').value = h.host || '';
                    document.getElementById('sftpPort').value = h.port || 22;
                    document.getElementById('sftpUser').value = h.user || '';
                    fillCredentialForm('sftp', h);
                    try {
                        const authPayload = getHostCredentialPayload(h);
                        SFTP.connect(h.host, h.port, h.user, authPayload);
                    } catch (err) {
                        Toast.error(err.message);
                    }
                }));
            }
        };

        const Security = {
            networks: [],
            async load() {
                if (!State.isAdmin) return;
                try {
                    const res = await apiFetch(`${Config.API}/api/security/private-networks`);
                    if (!res.ok) {
                        const data = await res.json().catch(() => ({}));
                        Toast.error(data.error || '加载白名单失败');
                        return;
                    }
                    const data = await res.json();
                    this.networks = Array.isArray(data.networks) ? data.networks : [];
                    this.render();
                } catch (e) {
                    Toast.error('加载白名单失败: ' + e.message);
                }
            },
            async update(networks) {
                try {
                    const res = await apiFetch(`${Config.API}/api/security/private-networks`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ networks })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        this.networks = data.networks || networks;
                        this.render();
                        Toast.success('白名单已更新');
                    } else {
                        Toast.error(data.error || '更新失败');
                    }
                } catch (e) {
                    Toast.error('更新失败: ' + e.message);
                }
            },
            async add() {
                const input = document.getElementById('privateNetInput');
                const value = input.value.trim();
                if (!value) {
                    Toast.error('请输入网段');
                    return;
                }
                const next = [...new Set([...this.networks, value])];
                input.value = '';
                await this.update(next);
            },
            async remove(index) {
                const next = this.networks.filter((_, i) => i !== index);
                await this.update(next);
            },
            render() {
                const el = document.getElementById('privateNetList');
                if (!el) return;
                if (!this.networks.length) {
                    el.innerHTML = '<div class="empty"><i class="fas fa-network-wired"></i><p>暂无白名单</p></div>';
                    return;
                }
                el.innerHTML = this.networks.map((net, i) => `
                    <div class="host-card" data-index="${i}">
                        <button class="host-delete" data-index="${i}"><i class="fas fa-times"></i></button>
                        <div class="host-card-content">
                            <div class="host-info"><i class="fas fa-network-wired"></i><span class="host-ip">${net}</span></div>
                            <div class="host-details">私有网段</div>
                        </div>
                    </div>
                `).join('');
                el.querySelectorAll('.host-delete').forEach(btn => btn.addEventListener('click', e => {
                    e.stopPropagation();
                    this.remove(+btn.dataset.index);
                }));
            }
        };

        // Waveform Visualizer - ES6 Class for oscilloscope-like visualization
        class WaveformVisualizer {
            constructor(canvasId, legendId, options = {}) {
                this.canvas = document.getElementById(canvasId);
                this.legendEl = document.getElementById(legendId);
                this.ctx = this.canvas.getContext('2d');

                // Configuration
                this.windowSize = options.windowSize || 200;
                this.paused = false;
                this.datasets = new Map(); // Map<string, { data: number[], color: string, latestValue: number }>
                this.chart = null;
                this.frameId = null;
                this.pendingUpdates = false;

                // Color palette for auto-assignment
                this.colorPalette = [
                    '#0078D7', '#107c10', '#e81123', '#ff8c00',
                    '#881798', '#3a96dd', '#00cc6a', '#f7630c',
                    '#ea005e', '#00b7c3', '#8764b8', '#567c73'
                ];
                this.colorIndex = 0;

                this._initChart();
            }

            _initChart() {
                const isDark = document.documentElement.getAttribute('data-theme') !== 'light';

                this.chart = new Chart(this.ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false, // Disable animation for performance
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: false // We use custom legend
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: isDark ? 'rgba(32,32,32,0.9)' : 'rgba(255,255,255,0.9)',
                                titleColor: isDark ? '#fff' : '#1a1a1a',
                                bodyColor: isDark ? '#a0a0a0' : '#666',
                                borderColor: isDark ? '#3a3a3a' : '#d0d0d0',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: isDark ? '#6a6a6a' : '#999',
                                    maxTicksLimit: 10,
                                    font: { size: 10 }
                                }
                            },
                            y: {
                                display: true,
                                grid: {
                                    color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: isDark ? '#6a6a6a' : '#999',
                                    font: { size: 10 }
                                }
                            }
                        },
                        elements: {
                            point: {
                                radius: 0 // Hide points for performance
                            },
                            line: {
                                tension: 0.2,
                                borderWidth: 2
                            }
                        }
                    }
                });

                // Generate initial labels
                this._updateLabels();
            }

            _updateLabels() {
                const labels = [];
                for (let i = 0; i < this.windowSize; i++) {
                    labels.push(i.toString());
                }
                this.chart.data.labels = labels;
            }

            _getNextColor() {
                const color = this.colorPalette[this.colorIndex % this.colorPalette.length];
                this.colorIndex++;
                return color;
            }

            _ensureDataset(key) {
                if (!this.datasets.has(key)) {
                    const color = this._getNextColor();
                    const data = new Array(this.windowSize).fill(null);
                    this.datasets.set(key, { data, color, latestValue: 0 });

                    // Add to chart
                    this.chart.data.datasets.push({
                        label: key,
                        data: [...data],
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: false
                    });

                    this._updateLegend();
                }
                return this.datasets.get(key);
            }

            _updateLegend() {
                if (!this.legendEl) return;

                let html = '';
                this.datasets.forEach((dataset, key) => {
                    const valueStr = dataset.latestValue !== null ? dataset.latestValue.toFixed(2) : '-';
                    html += `
                        <div class="waveform-legend-item">
                            <div class="waveform-legend-color" style="background:${dataset.color}"></div>
                            <span class="waveform-legend-label">${key}</span>
                            <span class="waveform-legend-value">${valueStr}</span>
                        </div>
                    `;
                });
                this.legendEl.innerHTML = html;
            }

            pushData(key, value) {
                if (this.paused) return;

                const numValue = parseFloat(value);
                if (isNaN(numValue)) return;

                const dataset = this._ensureDataset(key);
                dataset.data.push(numValue);
                dataset.latestValue = numValue;

                // Maintain sliding window
                while (dataset.data.length > this.windowSize) {
                    dataset.data.shift();
                }

                // Pad with nulls if needed
                while (dataset.data.length < this.windowSize) {
                    dataset.data.unshift(null);
                }

                this.pendingUpdates = true;
                this._scheduleRender();
            }

            _scheduleRender() {
                if (this.frameId) return;

                this.frameId = requestAnimationFrame(() => {
                    this.frameId = null;
                    if (this.pendingUpdates) {
                        this._render();
                        this.pendingUpdates = false;
                    }
                });
            }

            _render() {
                // Update chart datasets
                let idx = 0;
                this.datasets.forEach((dataset, key) => {
                    if (this.chart.data.datasets[idx]) {
                        this.chart.data.datasets[idx].data = [...dataset.data];
                    }
                    idx++;
                });

                this.chart.update('none'); // Update without animation
                this._updateLegend();
            }

            setWindowSize(size) {
                this.windowSize = Math.max(50, Math.min(1000, size));
                this._updateLabels();

                // Resize all datasets
                this.datasets.forEach((dataset) => {
                    while (dataset.data.length > this.windowSize) {
                        dataset.data.shift();
                    }
                    while (dataset.data.length < this.windowSize) {
                        dataset.data.unshift(null);
                    }
                });

                this._render();
            }

            pause() {
                this.paused = true;
            }

            resume() {
                this.paused = false;
            }

            togglePause() {
                this.paused = !this.paused;
                return this.paused;
            }

            clear() {
                this.datasets.clear();
                this.chart.data.datasets = [];
                this.colorIndex = 0;
                this._updateLegend();
                this.chart.update('none');
            }

            destroy() {
                if (this.frameId) {
                    cancelAnimationFrame(this.frameId);
                }
                if (this.chart) {
                    this.chart.destroy();
                }
            }
        }

        // StatChart Visualizer - Bar chart for statistics data
        // Format: var:[a:2, b:3, c:5, d:6] or multiple: var1:[a:4, b:6], var2:[a:6, b:3]
        class StatChartVisualizer {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.chart = null;
                this.datasets = new Map(); // Map<varName, Map<subKey, value>>
                this.frameId = null;
                this.pendingUpdates = false;

                // Color palette for sub-variables (a, b, c, d, etc.)
                this.colorPalette = [
                    '#0078D7', '#107c10', '#e81123', '#ff8c00',
                    '#881798', '#3a96dd', '#00cc6a', '#f7630c',
                    '#ea005e', '#00b7c3', '#8764b8', '#567c73',
                    '#c239b3', '#6b69d6', '#038387', '#ca5010'
                ];
                this.subKeyColors = new Map(); // Map<subKey, color>
                this.colorIndex = 0;

                this._initChart();
            }

            _initChart() {
                const isDark = document.documentElement.getAttribute('data-theme') !== 'light';

                this.chart = new Chart(this.ctx, {
                    type: 'bar',
                    data: {
                        labels: [], // Variable names (var1, var2, ...)
                        datasets: [] // Each dataset is a sub-key (a, b, c, d, ...)
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 300 },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: isDark ? '#a0a0a0' : '#666',
                                    font: { size: 11 },
                                    boxWidth: 12,
                                    padding: 8
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: isDark ? 'rgba(32,32,32,0.9)' : 'rgba(255,255,255,0.9)',
                                titleColor: isDark ? '#fff' : '#1a1a1a',
                                bodyColor: isDark ? '#a0a0a0' : '#666',
                                borderColor: isDark ? '#3a3a3a' : '#d0d0d0',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: isDark ? '#a0a0a0' : '#666',
                                    font: { size: 11 }
                                }
                            },
                            y: {
                                display: true,
                                beginAtZero: true,
                                grid: {
                                    color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: isDark ? '#a0a0a0' : '#666',
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });
            }

            _getColorForSubKey(subKey) {
                if (!this.subKeyColors.has(subKey)) {
                    const color = this.colorPalette[this.colorIndex % this.colorPalette.length];
                    this.subKeyColors.set(subKey, color);
                    this.colorIndex++;
                }
                return this.subKeyColors.get(subKey);
            }

            // Parse format: var:[a:2, b:3, c:5] or var1:[a:4, b:6], var2:[a:6, b:3]
            parseStatLine(line) {
                const results = [];
                // Match pattern: varName:[key:value, key:value, ...]
                const regex = /([A-Za-z_][A-Za-z0-9_]*):\s*\[([^\]]+)\]/g;
                let match;

                while ((match = regex.exec(line)) !== null) {
                    const varName = match[1];
                    const content = match[2];
                    const pairs = {};

                    // Parse key:value pairs inside brackets
                    const pairRegex = /([A-Za-z_][A-Za-z0-9_]*)\s*:\s*(-?\d+\.?\d*)/g;
                    let pairMatch;
                    while ((pairMatch = pairRegex.exec(content)) !== null) {
                        pairs[pairMatch[1]] = parseFloat(pairMatch[2]);
                    }

                    if (Object.keys(pairs).length > 0) {
                        results.push({ varName, pairs });
                    }
                }

                return results.length > 0 ? results : null;
            }

            pushData(varName, pairs) {
                if (!this.datasets.has(varName)) {
                    this.datasets.set(varName, new Map());
                }
                const varData = this.datasets.get(varName);

                for (const [subKey, value] of Object.entries(pairs)) {
                    varData.set(subKey, value);
                }

                this.pendingUpdates = true;
                this._scheduleRender();
            }

            _scheduleRender() {
                if (this.frameId) return;

                this.frameId = requestAnimationFrame(() => {
                    this.frameId = null;
                    if (this.pendingUpdates) {
                        this._render();
                        this.pendingUpdates = false;
                    }
                });
            }

            _render() {
                // Collect all unique sub-keys across all variables
                const allSubKeys = new Set();
                this.datasets.forEach((varData) => {
                    varData.forEach((_, subKey) => allSubKeys.add(subKey));
                });

                // Sort sub-keys for consistent ordering
                const sortedSubKeys = Array.from(allSubKeys).sort();

                // Variable names as labels
                const varNames = Array.from(this.datasets.keys());

                // Build datasets (one per sub-key)
                const chartDatasets = sortedSubKeys.map(subKey => {
                    const color = this._getColorForSubKey(subKey);
                    const data = varNames.map(varName => {
                        const varData = this.datasets.get(varName);
                        return varData.has(subKey) ? varData.get(subKey) : 0;
                    });

                    return {
                        label: subKey,
                        data: data,
                        backgroundColor: color + 'CC',
                        borderColor: color,
                        borderWidth: 1
                    };
                });

                this.chart.data.labels = varNames;
                this.chart.data.datasets = chartDatasets;
                this.chart.update('none');
            }

            clear() {
                this.datasets.clear();
                this.subKeyColors.clear();
                this.colorIndex = 0;
                this.chart.data.labels = [];
                this.chart.data.datasets = [];
                this.chart.update('none');
            }

            destroy() {
                if (this.frameId) {
                    cancelAnimationFrame(this.frameId);
                }
                if (this.chart) {
                    this.chart.destroy();
                }
            }
        }

        // System Stats Visualizer - Line chart for CPU, Memory, Disk I/O
        class SysStatsVisualizer {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.chart = null;
                this.maxDataPoints = 60; // 60 data points (about 1 minute at 1s interval)
                this.cpuData = [];
                this.memData = [];
                this.diskReadData = [];
                this.diskWriteData = [];
                this.labels = [];
                this.lastDiskStats = null;
                this.lastDiskTime = null;
                this._initChart();
            }

            _initChart() {
                const isDark = document.documentElement.getAttribute('data-theme') !== 'light';

                this.chart = new Chart(this.ctx, {
                    type: 'line',
                    data: {
                        labels: this.labels,
                        datasets: [
                            {
                                label: 'CPU %',
                                data: this.cpuData,
                                borderColor: '#0078D7',
                                backgroundColor: 'rgba(0, 120, 215, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3,
                                pointRadius: 0
                            },
                            {
                                label: '内存 %',
                                data: this.memData,
                                borderColor: '#107c10',
                                backgroundColor: 'rgba(16, 124, 16, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3,
                                pointRadius: 0
                            },
                            {
                                label: '磁盘读 KB/s',
                                data: this.diskReadData,
                                borderColor: '#ff8c00',
                                backgroundColor: 'rgba(255, 140, 0, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3,
                                pointRadius: 0,
                                yAxisID: 'y1'
                            },
                            {
                                label: '磁盘写 KB/s',
                                data: this.diskWriteData,
                                borderColor: '#e81123',
                                backgroundColor: 'rgba(232, 17, 35, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3,
                                pointRadius: 0,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: isDark ? '#a0a0a0' : '#666',
                                    font: { size: 11 },
                                    boxWidth: 12,
                                    padding: 8
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: isDark ? 'rgba(32,32,32,0.9)' : 'rgba(255,255,255,0.9)',
                                titleColor: isDark ? '#fff' : '#1a1a1a',
                                bodyColor: isDark ? '#a0a0a0' : '#666',
                                borderColor: isDark ? '#3a3a3a' : '#d0d0d0',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                display: false
                            },
                            y: {
                                display: true,
                                position: 'left',
                                min: 0,
                                max: 100,
                                grid: {
                                    color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: isDark ? '#a0a0a0' : '#666',
                                    font: { size: 10 },
                                    callback: (value) => value + '%'
                                }
                            },
                            y1: {
                                display: true,
                                position: 'right',
                                min: 0,
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    color: isDark ? '#a0a0a0' : '#666',
                                    font: { size: 10 },
                                    callback: (value) => value.toFixed(0) + ' KB/s'
                                }
                            }
                        }
                    }
                });
            }

            // Parse /proc/loadavg output: "0.00 0.01 0.05 1/234 12345"
            parseLoadAvg(line) {
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 3) {
                    // 1-minute load average, normalize to percentage (rough estimate based on CPU count)
                    return parseFloat(parts[0]);
                }
                return null;
            }

            // Parse /proc/meminfo output
            parseMemInfo(lines) {
                const info = {};
                for (const line of lines) {
                    const match = line.match(/^(\w+):\s+(\d+)/);
                    if (match) {
                        info[match[1]] = parseInt(match[2]);
                    }
                }
                if (info.MemTotal && info.MemAvailable !== undefined) {
                    const used = info.MemTotal - info.MemAvailable;
                    return (used / info.MemTotal * 100).toFixed(1);
                }
                return null;
            }

            // Parse /proc/diskstats output
            parseDiskStats(lines, currentTime) {
                let totalReadSectors = 0;
                let totalWriteSectors = 0;

                for (const line of lines) {
                    const parts = line.trim().split(/\s+/);
                    if (parts.length >= 14) {
                        const deviceName = parts[2];
                        // Only count major block devices (sda, vda, nvme0n1, etc.), not partitions
                        if (/^(sd[a-z]|vd[a-z]|nvme\d+n\d+|xvd[a-z])$/.test(deviceName)) {
                            totalReadSectors += parseInt(parts[5]) || 0;  // sectors read
                            totalWriteSectors += parseInt(parts[9]) || 0; // sectors written
                        }
                    }
                }

                if (this.lastDiskStats && this.lastDiskTime) {
                    const timeDelta = (currentTime - this.lastDiskTime) / 1000; // seconds
                    const readDelta = totalReadSectors - this.lastDiskStats.read;
                    const writeDelta = totalWriteSectors - this.lastDiskStats.write;
                    // Each sector is 512 bytes
                    const readKBps = (readDelta * 512 / 1024 / timeDelta).toFixed(1);
                    const writeKBps = (writeDelta * 512 / 1024 / timeDelta).toFixed(1);

                    this.lastDiskStats = { read: totalReadSectors, write: totalWriteSectors };
                    this.lastDiskTime = currentTime;

                    return { read: parseFloat(readKBps), write: parseFloat(writeKBps) };
                }

                this.lastDiskStats = { read: totalReadSectors, write: totalWriteSectors };
                this.lastDiskTime = currentTime;
                return null;
            }

            // Parse /proc/stat for CPU usage
            parseCpuStat(lines) {
                for (const line of lines) {
                    if (line.startsWith('cpu ')) {
                        const parts = line.split(/\s+/).slice(1).map(Number);
                        // user, nice, system, idle, iowait, irq, softirq, steal
                        const [user, nice, system, idle, iowait = 0, irq = 0, softirq = 0, steal = 0] = parts;
                        const total = user + nice + system + idle + iowait + irq + softirq + steal;
                        const busy = user + nice + system + irq + softirq + steal;
                        return { total, busy };
                    }
                }
                return null;
            }

            pushData(cpu, mem, diskRead, diskWrite) {
                const now = new Date();
                const timeLabel = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                this.cpuData.push(cpu);
                this.memData.push(mem);
                this.diskReadData.push(diskRead);
                this.diskWriteData.push(diskWrite);
                this.labels.push(timeLabel);

                // Keep only last N data points
                if (this.cpuData.length > this.maxDataPoints) {
                    this.cpuData.shift();
                    this.memData.shift();
                    this.diskReadData.shift();
                    this.diskWriteData.shift();
                    this.labels.shift();
                }

                this.chart.update('none');
            }

            clear() {
                this.cpuData.length = 0;
                this.memData.length = 0;
                this.diskReadData.length = 0;
                this.diskWriteData.length = 0;
                this.labels.length = 0;
                this.lastDiskStats = null;
                this.lastDiskTime = null;
                document.getElementById('statCpuValue').textContent = '--%';
                document.getElementById('statMemValue').textContent = '--%';
                document.getElementById('statDiskValue').textContent = '-- KB/s';
                this.chart.update('none');
            }

            destroy() {
                if (this.chart) {
                    this.chart.destroy();
                }
            }
        }

        // 串口终端 (WebSerial API)
        const Serial = {
            port: null,
            reader: null,
            writer: null,
            term: null,
            fit: null,
            connected: false,
            readLoop: null,
            platformDenied: false,
            // Waveform visualization
            waveformVisualizer: null,
            waveformActive: false,
            // Stat chart visualization
            statChartVisualizer: null,
            statChartActive: false,
            lineBuffer: '', // Buffer for line-based parsing
            // Demo mode
            demoMode: false,
            demoInterval: null,
            demoTime: 0,

            init() {
                // 检查浏览器支持
                const platform = navigator.platform || '';
                const userAgent = navigator.userAgent || '';
                const isWindows = /Win/.test(platform) || /Windows/.test(userAgent);
                if (isWindows) {
                    this.platformDenied = true;
                    const tip = document.getElementById('serialNotSupported');
                    tip.style.display = 'block';
                    tip.innerHTML =
                        '<p style="color:var(--color-warning);margin-bottom:8px"><i class="fas fa-exclamation-triangle"></i> 当前平台不允许访问串口</p>' +
                        '<p style="color:var(--color-text-2);font-size:12px">仅允许访问 /dev/ 下的串口设备</p>';
                    document.getElementById('serialConnectBtn').disabled = true;
                    return;
                }
                if (!('serial' in navigator)) {
                    document.getElementById('serialNotSupported').style.display = 'block';
                    document.getElementById('serialConnectBtn').disabled = true;
                    return;
                }

                // 初始化终端
                this.term = new Terminal({
                    theme: {
                        background: '#1a1a1a', foreground: '#fff', cursor: '#0078D7',
                        selection: 'rgba(0,120,215,0.3)',
                        black: '#1a1a1a', red: '#e81123', green: '#107c10', yellow: '#ff8c00',
                        blue: '#0078D7', magenta: '#881798', cyan: '#3a96dd', white: '#ccc'
                    },
                    fontFamily: 'Consolas, Monaco, monospace',
                    fontSize: 14, cursorBlink: true,
                    convertEol: true
                });
                this.fit = new FitAddon.FitAddon();
                this.term.loadAddon(this.fit);
                this.term.open(document.getElementById('serialTerminal'));
                this.doFit();
                this.welcome();

                window.addEventListener('resize', () => this.doFit());

                // 终端输入处理
                this.term.onData(data => {
                    if (this.connected && this.writer) {
                        this.write(data);
                    }
                });

                // 绑定事件
                document.getElementById('serialConnectBtn').addEventListener('click', () => this.connect());
                document.getElementById('serialDisconnectBtn').addEventListener('click', () => this.disconnect());
                document.getElementById('serialClearBtn').addEventListener('click', () => { this.term.clear(); this.welcome(); });
                document.getElementById('serialSendBtn').addEventListener('click', () => this.sendData());
                document.getElementById('serialSendInput').addEventListener('keypress', e => { if (e.key === 'Enter') this.sendData(); });

                // Waveform event handlers
                document.getElementById('serialWaveformBtn').addEventListener('click', () => this.toggleWaveform());
                document.getElementById('waveformPauseBtn').addEventListener('click', () => this.toggleWaveformPause());
                document.getElementById('waveformClearBtn').addEventListener('click', () => this.clearWaveform());
                document.getElementById('waveformWindowSize').addEventListener('change', (e) => {
                    if (this.waveformVisualizer) {
                        this.waveformVisualizer.setWindowSize(parseInt(e.target.value));
                    }
                });

                // Stat chart event handlers
                document.getElementById('serialStatChartBtn').addEventListener('click', () => this.toggleStatChart());
                document.getElementById('statChartClearBtn').addEventListener('click', () => this.clearStatChart());

                // Demo mode button
                document.getElementById('serialDemoBtn').addEventListener('click', () => this.startDemo());
            },

            // Start demo mode - simulates waveform data without real serial port
            startDemo() {
                if (this.connected || this.demoMode) {
                    Toast.info('请先断开当前连接');
                    return;
                }

                this.demoMode = true;
                this.connected = true;
                this.demoTime = 0;
                this.updateStatus(true, true);
                this.term.clear();
                this.term.writeln('\x1b[32m演示模式已启动 (模拟数据)\x1b[0m');
                this.term.writeln('\x1b[90m波形数据: Sin, Cos, Sin3Hz, ADC, Temp\x1b[0m');
                this.term.writeln('\x1b[90m统计数据: stats:[a:x, b:x, c:x, d:x] 格式\x1b[0m');
                this.term.writeln('\x1b[90m点击 "波形" 或 "统计" 按钮查看实时图表\x1b[0m\n');

                // Auto-enable waveform view
                if (!this.waveformActive) {
                    this.toggleWaveform();
                }

                Toast.success('演示模式已启动');

                // Start generating demo data at 50Hz
                this.demoInterval = setInterval(() => {
                    const t = this.demoTime;

                    // Generate waveform data
                    const sin = Math.sin(2 * Math.PI * 1.0 * t).toFixed(3);
                    const cos = Math.cos(2 * Math.PI * 1.0 * t).toFixed(3);
                    const sin3 = (0.5 * Math.sin(2 * Math.PI * 3.0 * t)).toFixed(3);
                    const adcBase = 2048 + 1800 * Math.sin(2 * Math.PI * 0.5 * t);
                    const adc = Math.floor(Math.max(0, Math.min(4095, adcBase + (Math.random() - 0.5) * 100)));
                    const temp = (25 + 5 * Math.sin(2 * Math.PI * 0.1 * t) + (Math.random() - 0.5) * 0.4).toFixed(2);

                    // Process as if received from serial
                    const lines = [
                        `Sin:${sin}`,
                        `Cos:${cos}`,
                        `Sin3Hz:${sin3}`,
                        `ADC:${adc}`,
                        `Temp:${temp}`
                    ];

                    lines.forEach(line => {
                        const waveformDataArray = this.parseWaveformLine(line);
                        if (waveformDataArray && this.waveformActive && this.waveformVisualizer) {
                            waveformDataArray.forEach(data => {
                                this.waveformVisualizer.pushData(data.key, data.value);
                            });
                        }
                    });

                    // Generate stat chart data every 500ms (every 25 frames)
                    if (Math.floor(this.demoTime * 50) % 25 === 0) {
                        const a = Math.floor(Math.random() * 10 + 1);
                        const b = Math.floor(Math.random() * 10 + 1);
                        const c = Math.floor(Math.random() * 10 + 1);
                        const d = Math.floor(Math.random() * 10 + 1);
                        const statLine = `stats:[a:${a}, b:${b}, c:${c}, d:${d}]`;

                        // Parse and display stat chart data
                        if (this.statChartActive && this.statChartVisualizer) {
                            const statData = this.statChartVisualizer.parseStatLine(statLine);
                            if (statData) {
                                statData.forEach(item => {
                                    this.statChartVisualizer.pushData(item.varName, item.pairs);
                                });
                            }
                        }
                    }

                    this.demoTime += 0.02; // 50Hz = 20ms interval
                }, 20);
            },

            // Toggle waveform visualization
            toggleWaveform() {
                const container = document.getElementById('waveformContainer');
                const btn = document.getElementById('serialWaveformBtn');

                this.waveformActive = !this.waveformActive;
                container.classList.toggle('active', this.waveformActive);
                btn.classList.toggle('btn-secondary', !this.waveformActive);
                btn.classList.toggle('btn-success', this.waveformActive);

                if (this.waveformActive && !this.waveformVisualizer) {
                    // Initialize waveform visualizer on first activation
                    const windowSize = parseInt(document.getElementById('waveformWindowSize').value) || 200;
                    this.waveformVisualizer = new WaveformVisualizer('waveformCanvas', 'waveformLegend', { windowSize });
                }
            },

            // Toggle pause for waveform
            toggleWaveformPause() {
                if (!this.waveformVisualizer) return;
                const paused = this.waveformVisualizer.togglePause();
                const btn = document.getElementById('waveformPauseBtn');
                btn.innerHTML = paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
            },

            // Clear waveform data
            clearWaveform() {
                if (this.waveformVisualizer) {
                    this.waveformVisualizer.clear();
                }
            },

            // Toggle stat chart visualization
            toggleStatChart() {
                const container = document.getElementById('statChartContainer');
                const btn = document.getElementById('serialStatChartBtn');

                this.statChartActive = !this.statChartActive;
                container.classList.toggle('active', this.statChartActive);
                btn.classList.toggle('btn-secondary', !this.statChartActive);
                btn.classList.toggle('btn-success', this.statChartActive);

                if (this.statChartActive && !this.statChartVisualizer) {
                    this.statChartVisualizer = new StatChartVisualizer('statChartCanvas');
                }
            },

            // Clear stat chart data
            clearStatChart() {
                if (this.statChartVisualizer) {
                    this.statChartVisualizer.clear();
                }
            },

            // Check if line matches stat chart format (var:[a:2, b:3])
            isStatChartFormat(line) {
                return /[A-Za-z_][A-Za-z0-9_]*:\s*\[[^\]]+\]/.test(line);
            },

            // Parse data line for waveform format (Variable:Value)
            // Supports both single value and comma-separated multiple values
            parseWaveformLine(line) {
                // Match format: VariableName:NumericValue
                // Examples:
                //   Single: ADC1:1024, Temp:25.5, Sin:-0.5
                //   Multiple: a:2, b:4, temp:25.5
                const trimmedLine = line.trim();

                // Try to parse as comma-separated values first
                const pairs = trimmedLine.split(',').map(pair => pair.trim());
                const results = [];

                for (const pair of pairs) {
                    const match = pair.match(/^([A-Za-z_][A-Za-z0-9_]*):(-?\d+\.?\d*)$/);
                    if (match) {
                        results.push({ key: match[1], value: parseFloat(match[2]) });
                    }
                }

                return results.length > 0 ? results : null;
            },

            doFit() {
                try { this.fit.fit(); } catch {}
            },

            welcome() {
                this.term.writeln('');
                this.term.writeln('\x1b[1;34m  ╔══════════════════════════════════════════╗\x1b[0m');
                this.term.writeln('\x1b[1;34m  ║\x1b[0m    \x1b[1;36mSerial Terminal (WebSerial)\x1b[0m          \x1b[1;34m║\x1b[0m');
                this.term.writeln('\x1b[1;34m  ╚══════════════════════════════════════════╝\x1b[0m');
                this.term.writeln('');
                this.term.writeln('\x1b[90m  点击 "连接串口" 按钮选择串口设备\x1b[0m');
                this.term.writeln('');
            },

            async connect() {
                try {
                    if (this.platformDenied) {
                        Toast.error('当前平台不允许访问串口');
                        return;
                    }
                    // 请求串口
                    this.port = await navigator.serial.requestPort();

                    // 获取配置
                    const baudRate = parseInt(document.getElementById('serialBaudRate').value);
                    const dataBits = parseInt(document.getElementById('serialDataBits').value);
                    const stopBits = parseInt(document.getElementById('serialStopBits').value);
                    const parity = document.getElementById('serialParity').value;
                    const flowControl = document.getElementById('serialFlowControl').value;

                    // 打开串口
                    await this.port.open({
                        baudRate,
                        dataBits,
                        stopBits,
                        parity,
                        flowControl
                    });

                    this.connected = true;
                    this.updateStatus(true);
                    this.term.clear();
                    this.term.writeln(`\x1b[32m串口已连接 (${baudRate} bps)\x1b[0m\n`);

                    // 设置读写
                    const textDecoder = new TextDecoderStream();
                    const readableStreamClosed = this.port.readable.pipeTo(textDecoder.writable);
                    this.reader = textDecoder.readable.getReader();

                    const textEncoder = new TextEncoderStream();
                    const writableStreamClosed = textEncoder.readable.pipeTo(this.port.writable);
                    this.writer = textEncoder.writable.getWriter();

                    // 开始读取
                    this.readLoop = this.startReading();

                    Toast.success('串口已连接');
                } catch (e) {
                    if (e.name !== 'NotFoundError') {
                        Toast.error('连接失败: ' + e.message);
                        this.term.writeln(`\x1b[31m连接失败: ${e.message}\x1b[0m`);
                    }
                }
            },

            async startReading() {
                const showHex = () => document.getElementById('serialShowHex').checked;
                const autoScroll = () => document.getElementById('serialAutoScroll').checked;

                try {
                    while (this.connected) {
                        const { value, done } = await this.reader.read();
                        if (done) break;
                        if (value) {
                            // Buffer incoming data for line-based parsing
                            this.lineBuffer += value;

                            // Process complete lines
                            let newlineIdx;
                            while ((newlineIdx = this.lineBuffer.indexOf('\n')) !== -1) {
                                const line = this.lineBuffer.substring(0, newlineIdx).replace(/\r$/, '');
                                this.lineBuffer = this.lineBuffer.substring(newlineIdx + 1);

                                // Check if line matches stat chart format (var:[a:2, b:3])
                                const isStatData = this.isStatChartFormat(line);

                                // Parse stat chart data if format matches
                                if (isStatData && this.statChartActive && this.statChartVisualizer) {
                                    const statData = this.statChartVisualizer.parseStatLine(line);
                                    if (statData) {
                                        statData.forEach(item => {
                                            this.statChartVisualizer.pushData(item.varName, item.pairs);
                                        });
                                    }
                                }

                                // Only parse as waveform if NOT stat chart format
                                if (!isStatData) {
                                    const waveformDataArray = this.parseWaveformLine(line);
                                    if (waveformDataArray && this.waveformActive && this.waveformVisualizer) {
                                        waveformDataArray.forEach(data => {
                                            this.waveformVisualizer.pushData(data.key, data.value);
                                        });
                                    }
                                }

                                // Always print to terminal
                                if (showHex()) {
                                    const hex = Array.from(new TextEncoder().encode(line + '\n'))
                                        .map(b => b.toString(16).padStart(2, '0').toUpperCase())
                                        .join(' ');
                                    this.term.write(`\x1b[33m${hex}\x1b[0m `);
                                } else {
                                    this.term.writeln(line);
                                }
                            }

                            // Handle partial data (no newline yet) - only if buffer gets too large
                            // or contains non-waveform data that should be displayed immediately
                            if (this.lineBuffer.length > 256) {
                                // Flush buffer to terminal if it gets too large
                                if (showHex()) {
                                    const hex = Array.from(new TextEncoder().encode(this.lineBuffer))
                                        .map(b => b.toString(16).padStart(2, '0').toUpperCase())
                                        .join(' ');
                                    this.term.write(`\x1b[33m${hex}\x1b[0m `);
                                } else {
                                    this.term.write(this.lineBuffer);
                                }
                                this.lineBuffer = '';
                            }

                            if (autoScroll()) {
                                this.term.scrollToBottom();
                            }
                        }
                    }
                } catch (e) {
                    if (this.connected) {
                        this.term.writeln(`\n\x1b[31m读取错误: ${e.message}\x1b[0m`);
                    }
                }
            },

            async write(data) {
                if (this.writer) {
                    try {
                        await this.writer.write(data);
                    } catch (e) {
                        console.error('写入错误:', e);
                    }
                }
            },

            async sendData() {
                if (!this.connected) return;

                let data = document.getElementById('serialSendInput').value;
                const mode = document.getElementById('serialSendMode').value;
                const lineEnding = document.getElementById('serialLineEnding').value;

                if (!data) return;

                if (mode === 'hex') {
                    // HEX 模式：将空格分隔的十六进制字符串转换为字节
                    const hexBytes = data.replace(/\s/g, '').match(/.{1,2}/g);
                    if (hexBytes) {
                        const bytes = hexBytes.map(h => parseInt(h, 16));
                        const uint8 = new Uint8Array(bytes);
                        await this.writer.write(new TextDecoder().decode(uint8));
                    }
                } else {
                    // 文本模式
                    data += lineEnding.replace(/\\n/g, '\n').replace(/\\r/g, '\r');
                    await this.write(data);
                }

                document.getElementById('serialSendInput').value = '';
            },

            async disconnect() {
                this.connected = false;
                this.lineBuffer = ''; // Clear the line buffer

                // Stop demo mode if active
                if (this.demoMode) {
                    if (this.demoInterval) {
                        clearInterval(this.demoInterval);
                        this.demoInterval = null;
                    }
                    this.demoMode = false;
                    this.updateStatus(false);
                    this.term.writeln('\n\x1b[33m演示模式已停止\x1b[0m');
                    Toast.info('演示模式已停止');
                    return;
                }

                try {
                    if (this.reader) {
                        await this.reader.cancel();
                        this.reader = null;
                    }
                    if (this.writer) {
                        await this.writer.close();
                        this.writer = null;
                    }
                    if (this.port) {
                        await this.port.close();
                        this.port = null;
                    }
                } catch (e) {
                    console.error('断开错误:', e);
                }

                this.updateStatus(false);
                this.term.writeln('\n\x1b[33m串口已断开\x1b[0m');
                Toast.info('串口已断开');
            },

            updateStatus(connected, isDemo = false) {
                const status = document.getElementById('serialStatus');
                const text = document.getElementById('serialStatusText');
                const disconnBtn = document.getElementById('serialDisconnectBtn');
                const connBtn = document.getElementById('serialConnectBtn');
                const demoBtn = document.getElementById('serialDemoBtn');
                const sendBtn = document.getElementById('serialSendBtn');
                const title = document.getElementById('serialTermTitle');

                if (connected) {
                    status.classList.remove('disconnected');
                    status.classList.add('connected');
                    text.textContent = isDemo ? '演示模式' : '已连接';
                    disconnBtn.style.display = 'inline-flex';
                    connBtn.disabled = true;
                    demoBtn.disabled = true;
                    sendBtn.disabled = isDemo; // Disable send in demo mode
                    title.textContent = isDemo ? '串口终端 - 演示模式' : '串口终端 - 已连接';
                } else {
                    status.classList.remove('connected');
                    status.classList.add('disconnected');
                    text.textContent = '未连接';
                    disconnBtn.style.display = 'none';
                    connBtn.disabled = false;
                    demoBtn.disabled = false;
                    sendBtn.disabled = true;
                    title.textContent = '串口终端 - 未连接';
                }
            }
        };

        // 本地 Shell
        const LocalShell = {
            term: null,
            fit: null,
            ws: null,
            connected: false,
            available: false,
            shellInfo: '',
            initialized: false,

            async init() {
                if (this.initialized) return;
                this.initialized = true;
                // 检查服务是否可用
                try {
                    const res = await apiFetch(`${Config.API}/api/localshell/status`);
                    if (!res.ok) {
                        throw new Error('unauthorized');
                    }
                    const data = await res.json();
                    this.available = data.available;
                    this.shellInfo = data.shell || '';
                    this.platform = data.platform || 'unknown';

                    // 显示 Linux 标签
                    document.getElementById('shellLinuxBadge').style.display = 'inline';

                    if (!this.available) {
                        document.getElementById('shellNotAvailable').style.display = 'block';
                        document.getElementById('shellStartBtn').disabled = true;
                        // 显示具体原因
                        if (this.platform !== 'linux') {
                            document.getElementById('shellNotAvailableReason').innerHTML =
                                `此功能仅支持 Linux 服务器<br><small style="color:var(--color-text-3)">当前服务器: ${this.platform}</small>`;
                        }
                    } else {
                        const displayShell = this.shellInfo === '/bin/bash' ? '/usr/bin/bash' : this.shellInfo;
                        document.getElementById('shellInfo').textContent = displayShell;
                    }
                } catch (e) {
                    console.error('[LocalShell] 检查状态失败:', e);
                    document.getElementById('shellNotAvailable').style.display = 'block';
                    document.getElementById('shellStartBtn').disabled = true;
                    document.getElementById('shellLinuxBadge').style.display = 'inline';
                }

                // 初始化终端
                this.term = new Terminal({
                    theme: {
                        background: '#1a1a1a', foreground: '#fff', cursor: '#0078D7',
                        selection: 'rgba(0,120,215,0.3)',
                        black: '#1a1a1a', red: '#e81123', green: '#107c10', yellow: '#ff8c00',
                        blue: '#0078D7', magenta: '#881798', cyan: '#3a96dd', white: '#ccc'
                    },
                    fontFamily: 'Consolas, Monaco, monospace',
                    fontSize: 14,
                    cursorBlink: true
                });
                this.fit = new FitAddon.FitAddon();
                this.term.loadAddon(this.fit);
                this.term.open(document.getElementById('shellTerminal'));
                this.doFit();
                this.welcome();

                window.addEventListener('resize', () => this.doFit());

                // 终端输入处理
                this.term.onData(data => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({ type: 'data', data }));
                    }
                });

                this.term.onResize(({ cols, rows }) => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({ type: 'resize', cols, rows }));
                    }
                });

                // 绑定事件
                document.getElementById('shellStartBtn').addEventListener('click', () => this.start());
                document.getElementById('shellStopBtn').addEventListener('click', () => this.stop());
                document.getElementById('shellClearBtn').addEventListener('click', () => {
                    this.term.clear();
                    if (!this.connected) this.welcome();
                });
            },

            doFit() {
                try { this.fit.fit(); } catch {}
            },

            welcome() {
                this.term.writeln('');
                this.term.writeln('\x1b[1;34m  ╔══════════════════════════════════════════╗\x1b[0m');
                this.term.writeln('\x1b[1;34m  ║\x1b[0m          \x1b[1;36mLocal Shell Terminal\x1b[0m            \x1b[1;34m║\x1b[0m');
                this.term.writeln('\x1b[1;34m  ╚══════════════════════════════════════════╝\x1b[0m');
                this.term.writeln('');
                this.term.writeln('\x1b[90m  点击 "启动" 按钮开启本地终端\x1b[0m');
                this.term.writeln('');
            },

            start() {
                if (!State.isAdmin) {
                    Toast.error('权限不足');
                    return;
                }
                if (!this.available) {
                    Toast.error('本地 Shell 服务不可用');
                    return;
                }

                if (this.ws) {
                    this.ws.close();
                }

                const shellPath = document.getElementById('shellPathInput').value.trim();
                const wsUrl = buildWsUrl('/localshell');
                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    const msg = {
                        type: 'start',
                        cols: this.term.cols,
                        rows: this.term.rows
                    };
                    if (shellPath) {
                        msg.shell = shellPath;
                    }
                    this.ws.send(JSON.stringify(msg));
                };

                this.ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        switch (msg.type) {
                            case 'started':
                                this.connected = true;
                                this.term.clear();
                                this.updateStatus(true, msg.shell);
                                Toast.success('本地 Shell 已启动');
                                this.doFit();
                                break;
                            case 'data':
                                this.term.write(msg.data);
                                break;
                            case 'exit':
                                this.connected = false;
                                this.updateStatus(false);
                                this.term.writeln(`\n\x1b[33mShell 已退出 (code: ${msg.exitCode})\x1b[0m`);
                                Toast.info('Shell 已退出');
                                break;
                            case 'error':
                                Toast.error(msg.message);
                                this.term.writeln(`\x1b[31m错误: ${msg.message}\x1b[0m`);
                                break;
                        }
                    } catch (err) {
                        console.error('[LocalShell] 消息解析错误:', err);
                    }
                };

                this.ws.onerror = () => {
                    this.term.writeln('\x1b[31m连接失败，请确保后端服务正在运行\x1b[0m');
                    Toast.error('WebSocket 连接失败');
                };

                this.ws.onclose = () => {
                    if (this.connected) {
                        this.connected = false;
                        this.updateStatus(false);
                    }
                };
            },

            stop() {
                if (this.ws) {
                    this.ws.send(JSON.stringify({ type: 'stop' }));
                    this.ws.close();
                    this.ws = null;
                }
                this.connected = false;
                this.updateStatus(false);
                this.term.writeln('\n\x1b[33mShell 已停止\x1b[0m');
                Toast.info('Shell 已停止');
            },

            updateStatus(running, shell = '') {
                const status = document.getElementById('shellStatus');
                const text = document.getElementById('shellStatusText');
                const startBtn = document.getElementById('shellStartBtn');
                const stopBtn = document.getElementById('shellStopBtn');
                const title = document.getElementById('shellTermTitle');

                if (running) {
                    status.classList.remove('disconnected');
                    status.classList.add('connected');
                    text.textContent = '运行中';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-flex';
                    title.textContent = `本地终端 - ${shell || this.shellInfo}`;
                } else {
                    status.classList.remove('connected');
                    status.classList.add('disconnected');
                    text.textContent = '未启动';
                    startBtn.style.display = 'inline-flex';
                    stopBtn.style.display = 'none';
                    title.textContent = '本地终端 - 未启动';
                }
            }
        };

        // VNC 远程桌面
        const VNCModule = {
            initialized: false,

            init() {
                if (this.initialized) return;

                const container = document.getElementById('vncScreen');

                // 初始化 VNC 客户端（使用外部 vnc-client.js）
                if (typeof VNC !== 'undefined') {
                    VNC.init(container, {
                        onConnect: (host) => {
                            this.updateStatus(true, host);
                            document.getElementById('vncToolbar').style.display = 'flex';
                            document.querySelector('#vncScreen .vnc-placeholder')?.remove();
                            Toast.success(`VNC 已连接到 ${host}`);
                        },
                        onDisconnect: (clean) => {
                            this.updateStatus(false);
                            document.getElementById('vncToolbar').style.display = 'none';
                            if (!clean) {
                                Toast.error('VNC 连接意外断开');
                            } else {
                                Toast.info('VNC 已断开');
                            }
                        },
                        onError: (msg) => {
                            Toast.error(msg);
                        },
                        onDesktopName: (name) => {
                            document.getElementById('vncStatusText').textContent = `已连接: ${name}`;
                        }
                    });
                    this.initialized = true;
                    console.log('[VNC Module] 初始化完成');
                } else {
                    console.warn('[VNC Module] VNC 客户端未加载，稍后重试');
                    // 延迟重试（等待 ES module 加载）
                    setTimeout(() => this.init(), 500);
                }
            },

            connect() {
                const host = document.getElementById('vncHost').value.trim();
                const port = document.getElementById('vncPort').value || 5900;
                const password = document.getElementById('vncPassword').value;
                const viewOnly = document.getElementById('vncViewOnly').checked;
                const scaleViewport = document.getElementById('vncScaleViewport').checked;

                if (!host) {
                    Toast.error('请输入 VNC 主机地址');
                    return;
                }

                if (typeof VNC !== 'undefined') {
                    VNC.connect({
                        host,
                        port: parseInt(port),
                        password,
                        viewOnly,
                        scaleViewport
                    });
                } else {
                    Toast.error('VNC 模块未加载，请刷新页面');
                }
            },

            disconnect() {
                if (typeof VNC !== 'undefined') {
                    VNC.disconnect();
                }
            },

            sendCtrlAltDel() {
                if (typeof VNC !== 'undefined') {
                    VNC.sendCtrlAltDel();
                }
            },

            toggleFullscreen() {
                if (typeof VNC !== 'undefined') {
                    if (document.fullscreenElement) {
                        VNC.exitFullscreen();
                    } else {
                        VNC.requestFullscreen();
                    }
                }
            },

            updateStatus(connected, host = '') {
                const status = document.getElementById('vncStatus');
                const text = document.getElementById('vncStatusText');
                const disconnBtn = document.getElementById('vncDisconnectBtn');
                const connBtn = document.getElementById('vncConnectBtn');

                if (connected) {
                    status.classList.remove('disconnected');
                    status.classList.add('connected');
                    text.textContent = `已连接到 ${host}`;
                    disconnBtn.style.display = 'inline-flex';
                    connBtn.disabled = true;
                } else {
                    status.classList.remove('connected');
                    status.classList.add('disconnected');
                    text.textContent = '未连接';
                    disconnBtn.style.display = 'none';
                    connBtn.disabled = false;
                }
            }
        };

        // UI
        const UI = {
            init() {
                Theme.init();
                Auth.init();

                // 侧边栏
                document.getElementById('toggleSidebar').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('collapsed');
                    setTimeout(() => Terminal_.doFit(), 300);
                });

                // 导航
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => this.switchView(item.dataset.view));
                    item.addEventListener('mousemove', e => {
                        const rect = item.getBoundingClientRect();
                        item.style.setProperty('--x', `${e.clientX - rect.left}px`);
                        item.style.setProperty('--y', `${e.clientY - rect.top}px`);
                    });
                });

                document.getElementById('sshAuthType').addEventListener('change', (e) => updateAuthFields('ssh', e.target.value));
                document.getElementById('sftpAuthType').addEventListener('change', (e) => updateAuthFields('sftp', e.target.value));
                updateAuthFields('ssh', document.getElementById('sshAuthType').value);
                updateAuthFields('sftp', document.getElementById('sftpAuthType').value);

                // SSH
                document.getElementById('saveHostBtn').addEventListener('click', () => {
                    const host = document.getElementById('sshHost').value.trim();
                    const port = document.getElementById('sshPort').value || 22;
                    const user = document.getElementById('sshUser').value.trim();
                    if (!host || !user) {
                        Toast.error('请输入主机地址和用户名');
                        return;
                    }
                    try {
                        const authPayload = readCredentialForm('ssh', { requireCredential: false });
                        Hosts.add({ host, port, user, ...authPayload });
                    } catch (err) {
                        Toast.error(err.message);
                    }
                });
                // SSH Stats Monitor
                document.getElementById('sysStatsHint').addEventListener('click', () => Terminal_.toggleStats());
                document.getElementById('sysStatsClearBtn').addEventListener('click', () => Terminal_.clearStats());
                document.getElementById('sysStatsCloseBtn').addEventListener('click', () => Terminal_.toggleStats());

                // TOP Panel
                document.getElementById('topPanelHint').addEventListener('click', () => Terminal_.toggleTop());
                document.getElementById('topCloseBtn').addEventListener('click', () => Terminal_.toggleTop());
                document.getElementById('topRefreshBtn').addEventListener('click', () => Terminal_.refreshTop());
                document.getElementById('topSortBy').addEventListener('change', () => Terminal_.renderTopTable());
                document.getElementById('topShowCount').addEventListener('change', () => Terminal_.renderTopTable());

                // Kill Modal
                document.getElementById('killCancel').addEventListener('click', () => document.getElementById('killModal').classList.remove('active'));
                document.getElementById('killConfirm').addEventListener('click', () => Terminal_.killProcess());
                document.getElementById('killModal').addEventListener('click', e => { if (e.target.id === 'killModal') e.target.classList.remove('active'); });

                // SFTP
                document.getElementById('sftpConnectBtn').addEventListener('click', () => {
                    const host = document.getElementById('sftpHost').value.trim();
                    const port = document.getElementById('sftpPort').value || 22;
                    const user = document.getElementById('sftpUser').value.trim();
                    if (!host || !user) {
                        Toast.error('请输入主机地址和用户名');
                        return;
                    }
                    try {
                        const authPayload = readCredentialForm('sftp');
                        SFTP.connect(host, port, user, authPayload);
                    } catch (err) {
                        Toast.error(err.message);
                    }
                });
                document.getElementById('sftpDisconnectBtn').addEventListener('click', () => SFTP.disconnect());
                document.getElementById('sftpRefreshBtn').addEventListener('click', () => SFTP.list(State.currentPath));
                document.getElementById('sftpMkdirBtn').addEventListener('click', () => document.getElementById('mkdirModal').classList.add('active'));
                document.getElementById('sftpDownloadBtn').addEventListener('click', () => SFTP.download());
                document.getElementById('sftpDeleteBtn').addEventListener('click', () => { if (State.selectedFiles.length && confirm(`删除 "${State.selectedFiles[0].name}"?`)) SFTP.delete_(); });
                document.getElementById('goPathBtn').addEventListener('click', () => { if (State.sftpConnected) SFTP.navigate(document.getElementById('remotePath').value.trim()); });
                document.getElementById('remotePath').addEventListener('keypress', e => { if (e.key === 'Enter') document.getElementById('goPathBtn').click(); });
                // 导航按钮
                document.getElementById('navBackBtn').addEventListener('click', () => SFTP.goBack());
                document.getElementById('navForwardBtn').addEventListener('click', () => SFTP.goForward());
                document.getElementById('navUpBtn').addEventListener('click', () => SFTP.goUp());

                // 内网白名单
                document.getElementById('privateNetAddBtn').addEventListener('click', () => Security.add());
                document.getElementById('privateNetInput').addEventListener('keypress', e => {
                    if (e.key === 'Enter') Security.add();
                });

                // 上传
                document.getElementById('uploadFilesBtn').addEventListener('click', () => document.getElementById('fileInput').click());
                document.getElementById('uploadFolderBtn').addEventListener('click', () => document.getElementById('folderInput').click());
                document.getElementById('fileInput').addEventListener('change', e => { if (e.target.files.length) { SFTP.upload([...e.target.files]); e.target.value = ''; } });
                document.getElementById('folderInput').addEventListener('change', e => { if (e.target.files.length) { SFTP.upload([...e.target.files]); e.target.value = ''; } });

                // 拖放
                const area = document.getElementById('uploadArea');
                area.addEventListener('dragover', e => { e.preventDefault(); if (State.sftpConnected) area.classList.add('drag-over'); });
                area.addEventListener('dragleave', () => area.classList.remove('drag-over'));
                area.addEventListener('drop', e => { e.preventDefault(); area.classList.remove('drag-over'); if (State.sftpConnected && e.dataTransfer.files.length) SFTP.upload([...e.dataTransfer.files]); });

                // Modal: 新建文件夹
                document.getElementById('mkdirCancel').addEventListener('click', () => document.getElementById('mkdirModal').classList.remove('active'));
                document.getElementById('mkdirConfirm').addEventListener('click', () => {
                    const name = document.getElementById('mkdirName').value.trim();
                    if (name) { SFTP.mkdir(name); document.getElementById('mkdirModal').classList.remove('active'); document.getElementById('mkdirName').value = ''; }
                });
                document.getElementById('mkdirName').addEventListener('keypress', e => { if (e.key === 'Enter') document.getElementById('mkdirConfirm').click(); });
                document.getElementById('mkdirModal').addEventListener('click', e => { if (e.target.id === 'mkdirModal') e.target.classList.remove('active'); });

                // VNC
                document.getElementById('vncConnectBtn').addEventListener('click', () => VNCModule.connect());
                document.getElementById('vncDisconnectBtn').addEventListener('click', () => VNCModule.disconnect());
                document.getElementById('vncCtrlAltDelBtn').addEventListener('click', () => VNCModule.sendCtrlAltDel());
                document.getElementById('vncFullscreenBtn').addEventListener('click', () => VNCModule.toggleFullscreen());
                document.getElementById('vncViewOnly').addEventListener('change', (e) => {
                    if (typeof VNC !== 'undefined') VNC.setViewOnly(e.target.checked);
                });
                document.getElementById('vncScaleViewport').addEventListener('change', (e) => {
                    if (typeof VNC !== 'undefined') VNC.setScaleViewport(e.target.checked);
                });

                // Reveal 效果
                document.addEventListener('mousemove', e => {
                    document.querySelectorAll('.host-card').forEach(el => {
                        const rect = el.getBoundingClientRect();
                        el.style.setProperty('--x', `${e.clientX - rect.left}px`);
                        el.style.setProperty('--y', `${e.clientY - rect.top}px`);
                    });
                });

            },
            showDashboard() {
                document.getElementById('dashboard').classList.add('visible');
                this.applyRole();
                if (!this.started) {
                    this.started = true;
                    Terminal_.init();
                    Serial.init();
                    VNCModule.init();
                }
                if (State.isAdmin) {
                    LocalShell.init();
                    Security.load();
                }
                Hosts.load();
            },
            hideDashboard() {
                document.getElementById('dashboard').classList.remove('visible');
            },
            resetConnections() {
                if (Terminal_.ws) {
                    Terminal_.ws.close();
                    Terminal_.ws = null;
                }
                if (LocalShell.ws) {
                    LocalShell.ws.close();
                    LocalShell.ws = null;
                    LocalShell.connected = false;
                }
                if (typeof VNC !== 'undefined') {
                    VNC.disconnect();
                }
                State.sshConnected = false;
                State.sftpConnected = false;
                State.sftpSession = null;
                State.currentPath = '/';
            },
            applyRole() {
                const shellNav = document.querySelector('.nav-item[data-view="shell"]');
                const shellView = document.getElementById('view-shell');
                const securityNav = document.querySelector('.nav-item[data-view="security"]');
                const securityView = document.getElementById('view-security');
                if (!State.isAdmin) {
                    shellNav.style.display = 'none';
                    shellView.style.display = 'none';
                    securityNav.style.display = 'none';
                    securityView.style.display = 'none';
                    const activeView = document.querySelector('.nav-item.active')?.dataset.view;
                    if (activeView === 'shell' || activeView === 'security') {
                        this.switchView('ssh');
                    }
                } else {
                    shellNav.style.display = '';
                    shellView.style.display = '';
                    securityNav.style.display = '';
                    securityView.style.display = '';
                }
            },
            switchView(name) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.view === name));
                document.querySelectorAll('.view').forEach(v => v.classList.toggle('active', v.id === `view-${name}`));
                if (name === 'ssh') setTimeout(() => Terminal_.doFit(), 100);
                if (name === 'shell') setTimeout(() => LocalShell.doFit(), 100);
                if (name === 'serial') setTimeout(() => Serial.doFit(), 100);
            }
        };

        document.addEventListener('DOMContentLoaded', () => UI.init());
    })();
    </script>
</body>
</html>
